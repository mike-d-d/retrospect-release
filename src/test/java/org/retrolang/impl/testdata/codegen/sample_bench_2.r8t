// Based on https://code.earthengine.google.com/705ba57988f51d1ff90ebbc7bf33c83c

if prep {
  _ = cgtest(4)
  return cgtest(65)
}
return cgtest(200)

function cgtest(size) {
  keep = 4 * size

  scale = size * size / 100
  b0 = testBand(size * 0.3, size * 0.3, scale)
  b1 = testBand(size * 0.3, size * 0.7, scale)
  b2 = testBand(size * 0.7 , size * 0.5, scale)
  b3 = [x, y] -> floor(x) + floor(y) * size
  img = { b0, b1, b2, b3 }

  // Create a (lazily-computed) matrix of features
  features = matrix([size, size])
               | [i, j] -> feature([i - 0.5, j - 0.5], img)

  centroids =
      [[0, 0, 0], [0.6, 0, 0], [0, 0.6, 0], [0, 0, 0.6], [0.55, 0.55, 0.55],
       [0.2, 0.2, 0], [0.2, 0, 0.2], [0, 0.2, 0.2],
       [0.1, 0.1, 0.3], [0.3, 0.1, 0.1], [0.1, 0.3, 0.1]]

  // Classify each feature and save a list of the filtered results
  filtered = features
       | f -> classify(f, centroids, keep)
       | filter(f -> f.filter == 0)
       | saveSequential

  // Return the length of the list and its last element
  return { count: size(filtered), last: filtered[size(filtered)] }
}

function testBand(xc, yc, scale) =
    [x, y] -> testBandHelper([x, y] - [xc, yc], scale)

function testBandHelper(delta, scale) {
  d = delta ** 2
  d2 = d[2] + d[1]
  return 1 / (log(d2 / scale + 7 - 6) + 1)
}

// Evaluate each of the bands at the given xy coordinates and save the results
// as a struct.
function feature(xy, bands) = bands | b -> b @ xy | save

function classify(f, centroids, keep) {
  b0 = f.b0
  b1 = f.b1
  b2 = f.b2
  b3 = f.b3
  pt = [b0, b1, b2]
  // Spammy because we're approximating the results of translating the EE
  // expression, where the loop is on the client side.
  distance0 = dist(pt, centroids[1])
  distance1 = dist(pt, centroids[2])
  distance2 = dist(pt, centroids[3])
  distance3 = dist(pt, centroids[4])
  distance4 = dist(pt, centroids[5])
  distance5 = dist(pt, centroids[6])
  distance6 = dist(pt, centroids[7])
  distance7 = dist(pt, centroids[8])
  distance8 = dist(pt, centroids[9])
  distance9 = dist(pt, centroids[10])
  distance10 = dist(pt, centroids[11])
  distances = [[distance0, 0],
               [distance1, 1],
               [distance2, 2],
               [distance3, 3],
               [distance4, 4],
               [distance5, 5],
               [distance6, 6],
               [distance7, 7],
               [distance8, 8],
               [distance9, 9],
               [distance10, 10]]
  min = distances | minAt([1])

  // We don't yet have a way to build the struct incrementally, so we
  // assemble it in a single step.
  return { b0, b1, b2, b3,
           distance0, distance1, distance2, distance3, distance4, distance5,
           distance6, distance7, distance8, distance9, distance10,
           class: min[2],
           filter: b3 % keep }
}

function dist(pt, centroid) = (centroid - pt) ** 2 | sum

/* CODEGEN cgtest RETURNS
{count: 50,
 last:
    {b0: 0.19868774362729588, b1: 0.2576687013636895, b2: 0.1890531704608046,
     b3: 39200, class: 10,
     distance0: 0.14161108039143833, distance1: 0.2631857880386832,
     distance10: 0.0194616767556045, distance2: 0.19240863875501088,
     distance3: 0.2747472758384728, distance4: 0.33916050339446935,
     distance5: 0.03906850239504415, distance6: 0.06651471475619812,
     distance7: 0.04292233166164067, distance8: 0.046907889116758465,
     distance9: 0.04305405985016195,
     filter: 0}}
---
cgtest_0(i1):
   1: AtomicInteger.incrementAndGet(0);
   2: X2 ← null;
   3: I4 ← Math.multiplyExact(4, I1); ArithmeticException:→ 325
   4: I3 ← Math.multiplyExact(I1, I1); ArithmeticException:→ 325
   5: D5 ← dDiv(I3, 100);
   6: test Double.isNaN(D5) == 0; F:→ 325
   7: test I1 < 0; T:→ 325
   8: test I1 == 0; T:→ 325
   9: D7 ← dMul(I1, 0.3);
  10: D9 ← dMul(I1, 0.3);
  11: D11 ← dMul(I1, 0.3);
  12: D13 ← dMul(I1, 0.7);
  13: D15 ← dMul(I1, 0.7);
  14: D17 ← dMul(I1, 0.5);
  15: X3 ← null;
  16: X22 ← [];
  17: X19 ← null;
  18: I23 ← 1;
  19: I21 ← 0;
= 20: I21 ← iAdd(I21, 1);
  21: I24 ← I21;
  22: I25 ← I23;
= 23: X20 ← null;
  24: D27 ← dSub(I23, 0.5);
  25: D29 ← dSub(I24, 0.5);
  26: X26 ← null;
  27: [d0] ← at_1(X0, D27, D29, D7, D9, D5); X31 ← stackRest; unwind:→ 322
  28: D32 ← double[](TState.fnResultBytes(X0, 0), 0);
  29: TState.clearResultTemplates(X0);
  30: test X31 == null; T:→ 35
  31: X31 ← TState.fillStackEntry(X0, X31, ⟦CollectionCore.AtTransformed.afterAt⟧, ⟨d0⟩, mMemo_5@xxxx, null);
  32: test X31 == null; T:→ 35
  33: X26 ← newStackEntry(⟦sample_bench_2.r8t+2:50_0 b0 = at(f, "b0") ∥ f=TransformedCollection({b0: lambda@37:11⸨xc=D7, yc=D9, scale=D5⸩, b1: lambda@37:11⸨xc=D11, yc=D13, scale=D5⸩, b2: lambda@37:11⸨xc=D15, yc=D17, scale=D5⸩, b3: lambda@14:14⸨size=I1⸩}, lambda@47:40⸨xy=[D27, D29]⸩), centroids=[[0, 0, 0], [0.6, 0, 0], [0, 0.6, 0], [0, 0, 0.6], [0.55, 0.55, 0.55], [0.2, 0.2, 0], [0.2, 0, 0.2], [0, 0.2, 0.2], [0.1, 0.1, 0.3], [0.3, 0.1, 0.1], [0.1, 0.3, 0.1]], keep=I4⟧);
  34: X26 ← TState.fillStackEntry(X0, X31, X26, ⟨x0:*@xxxx⟩, mMemo_h115@xxxx, null);
- 35: [d0] ← at_1(X0, D27, D29, D11, D13, D5); X31 ← stackRest; unwind:→ 319
  36: D34 ← double[](TState.fnResultBytes(X0, 0), 0);
  37: TState.clearResultTemplates(X0);
  38: test X31 == null; T:→ 43
  39: X31 ← TState.fillStackEntry(X0, X31, ⟦CollectionCore.AtTransformed.afterAt⟧, ⟨d0⟩, mMemo_5@xxxx, null);
  40: test X31 == null; T:→ 43
  41: X36 ← newStackEntry(⟦sample_bench_2.r8t+2:51_1 b1 = at(f, "b1") ∥ f=TransformedCollection({b0: lambda@37:11⸨xc=D7, yc=D9, scale=D5⸩, b1: lambda@37:11⸨xc=D11, yc=D13, scale=D5⸩, b2: lambda@37:11⸨xc=D15, yc=D17, scale=D5⸩, b3: lambda@14:14⸨size=I1⸩}, lambda@47:40⸨xy=[D27, D29]⸩), centroids=[[0, 0, 0], [0.6, 0, 0], [0, 0.6, 0], [0, 0, 0.6], [0.55, 0.55, 0.55], [0.2, 0.2, 0], [0.2, 0, 0.2], [0, 0.2, 0.2], [0.1, 0.1, 0.3], [0.3, 0.1, 0.1], [0.1, 0.3, 0.1]], keep=I4, b0=D32⟧);
  42: X26 ← TState.fillStackEntry(X0, X31, X36, ⟨x0:*@xxxx⟩, mMemo_h115@xxxx, X26);
- 43: [d0] ← at_1(X0, D27, D29, D15, D17, D5); X31 ← stackRest; unwind:→ 316
  44: D36 ← double[](TState.fnResultBytes(X0, 0), 0);
  45: TState.clearResultTemplates(X0);
  46: test X31 == null; T:→ 51
  47: X31 ← TState.fillStackEntry(X0, X31, ⟦CollectionCore.AtTransformed.afterAt⟧, ⟨d0⟩, mMemo_5@xxxx, null);
  48: test X31 == null; T:→ 51
  49: X38 ← newStackEntry(⟦sample_bench_2.r8t+2:52_2 b2 = at(f, "b2") ∥ f=TransformedCollection({b0: lambda@37:11⸨xc=D7, yc=D9, scale=D5⸩, b1: lambda@37:11⸨xc=D11, yc=D13, scale=D5⸩, b2: lambda@37:11⸨xc=D15, yc=D17, scale=D5⸩, b3: lambda@14:14⸨size=I1⸩}, lambda@47:40⸨xy=[D27, D29]⸩), centroids=[[0, 0, 0], [0.6, 0, 0], [0, 0.6, 0], [0, 0, 0.6], [0.55, 0.55, 0.55], [0.2, 0.2, 0], [0.2, 0, 0.2], [0, 0.2, 0.2], [0.1, 0.1, 0.3], [0.3, 0.1, 0.1], [0.1, 0.3, 0.1]], keep=I4, b0=D32, b1=D34⟧);
  50: X26 ← TState.fillStackEntry(X0, X31, X38, ⟨x0:*@xxxx⟩, mMemo_h115@xxxx, X26);
- 51: I31 ← 0;
  52: D38 ← 0;
= 53: I40 ← iAdd(I31, 1);
  54: test I31 == 0; F:→ 67
  55: D41 ← D27;
= 56: test I40 == 1; F:→ 68
  57: I31 ← 1;
  58: D38 ← D41; → 53
= 59: X19 ← null;
  60: I23 ← 1;
= 61: test I21 < I1; T:→ 20
  62: test I23 < I1; F:→ 219
  63: I23 ← iAdd(I23, 1);
  64: I24 ← 1;
  65: I25 ← I23;
  66: I21 ← 1; → 23
- 67: D41 ← D29; → 56
- 68: I31 ← Math.toIntExact(d2l(Math.floor(D38))); ArithmeticException:→ 305
  69: I40 ← Math.toIntExact(d2l(Math.floor(D41))); ArithmeticException:→ 305
  70: I40 ← Math.multiplyExact(I40, I1); ArithmeticException:→ 305
  71: I40 ← Math.addExact(I31, I40); ArithmeticException:→ 305
  72: [d0] ← dist_2(X0, D32, D34, D36, 0, 0, 0); X31 ← stackRest; unwind:→ 303
  73: D27 ← double[](TState.fnResultBytes(X0, 0), 0);
  74: TState.clearResultTemplates(X0);
  75: test X31 == null; T:→ 78
  76: X29 ← newStackEntry(⟦sample_bench_2.r8t+2:57_6 distance0 = dist(pt, _t0) ∥ centroids=[[0, 0, 0], [0.6, 0, 0], [0, 0.6, 0], [0, 0, 0.6], [0.55, 0.55, 0.55], [0.2, 0.2, 0], [0.2, 0, 0.2], [0, 0.2, 0.2], [0.1, 0.1, 0.3], [0.3, 0.1, 0.1], [0.1, 0.3, 0.1]], keep=I4, b0=D32, b1=D34, b2=D36, b3=I40, pt=[D32, D34, D36]⟧);
  77: X26 ← TState.fillStackEntry(X0, X31, X29, ⟨x0:*@xxxx⟩, mMemo_h115@xxxx, X26);
- 78: [d0] ← dist_2(X0, D32, D34, D36, 0.6, 0, 0); X31 ← stackRest; unwind:→ 301
  79: D29 ← double[](TState.fnResultBytes(X0, 0), 0);
  80: TState.clearResultTemplates(X0);
  81: test X31 == null; T:→ 84
  82: X38 ← newStackEntry(⟦sample_bench_2.r8t+2:58_8 distance1 = dist(pt, _t0) ∥ centroids=[[0, 0, 0], [0.6, 0, 0], [0, 0.6, 0], [0, 0, 0.6], [0.55, 0.55, 0.55], [0.2, 0.2, 0], [0.2, 0, 0.2], [0, 0.2, 0.2], [0.1, 0.1, 0.3], [0.3, 0.1, 0.1], [0.1, 0.3, 0.1]], keep=I4, b0=D32, b1=D34, b2=D36, b3=I40, pt=[D32, D34, D36], distance0=D27⟧);
  83: X26 ← TState.fillStackEntry(X0, X31, X38, ⟨x0:*@xxxx⟩, mMemo_h115@xxxx, X26);
- 84: [d0] ← dist_2(X0, D32, D34, D36, 0, 0.6, 0); X31 ← stackRest; unwind:→ 299
  85: D38 ← double[](TState.fnResultBytes(X0, 0), 0);
  86: TState.clearResultTemplates(X0);
  87: test X31 == null; T:→ 90
  88: X41 ← newStackEntry(⟦sample_bench_2.r8t+2:59_10 distance2 = dist(pt, _t0) ∥ centroids=[[0, 0, 0], [0.6, 0, 0], [0, 0.6, 0], [0, 0, 0.6], [0.55, 0.55, 0.55], [0.2, 0.2, 0], [0.2, 0, 0.2], [0, 0.2, 0.2], [0.1, 0.1, 0.3], [0.3, 0.1, 0.1], [0.1, 0.3, 0.1]], keep=I4, b0=D32, b1=D34, b2=D36, b3=I40, pt=[D32, D34, D36], distance0=D27, distance1=D29⟧);
  89: X26 ← TState.fillStackEntry(X0, X31, X41, ⟨x0:*@xxxx⟩, mMemo_h115@xxxx, X26);
- 90: [d0] ← dist_2(X0, D32, D34, D36, 0, 0, 0.6); X31 ← stackRest; unwind:→ 297
  91: D41 ← double[](TState.fnResultBytes(X0, 0), 0);
  92: TState.clearResultTemplates(X0);
  93: test X31 == null; T:→ 96
  94: X43 ← newStackEntry(⟦sample_bench_2.r8t+2:60_12 distance3 = dist(pt, _t0) ∥ centroids=[[0, 0, 0], [0.6, 0, 0], [0, 0.6, 0], [0, 0, 0.6], [0.55, 0.55, 0.55], [0.2, 0.2, 0], [0.2, 0, 0.2], [0, 0.2, 0.2], [0.1, 0.1, 0.3], [0.3, 0.1, 0.1], [0.1, 0.3, 0.1]], keep=I4, b0=D32, b1=D34, b2=D36, b3=I40, pt=[D32, D34, D36], distance0=D27, distance1=D29, distance2=D38⟧);
  95: X26 ← TState.fillStackEntry(X0, X31, X43, ⟨x0:*@xxxx⟩, mMemo_h115@xxxx, X26);
- 96: [d0] ← dist_2(X0, D32, D34, D36, 0.55, 0.55, 0.55); X31 ← stackRest; unwind:→ 295
  97: D43 ← double[](TState.fnResultBytes(X0, 0), 0);
  98: TState.clearResultTemplates(X0);
  99: test X31 == null; T:→ 102
 100: X45 ← newStackEntry(⟦sample_bench_2.r8t+2:61_14 distance4 = dist(pt, _t0) ∥ centroids=[[0, 0, 0], [0.6, 0, 0], [0, 0.6, 0], [0, 0, 0.6], [0.55, 0.55, 0.55], [0.2, 0.2, 0], [0.2, 0, 0.2], [0, 0.2, 0.2], [0.1, 0.1, 0.3], [0.3, 0.1, 0.1], [0.1, 0.3, 0.1]], keep=I4, b0=D32, b1=D34, b2=D36, b3=I40, pt=[D32, D34, D36], distance0=D27, distance1=D29, distance2=D38, distance3=D41⟧);
 101: X26 ← TState.fillStackEntry(X0, X31, X45, ⟨x0:*@xxxx⟩, mMemo_h115@xxxx, X26);
-102: [d0] ← dist_2(X0, D32, D34, D36, 0.2, 0.2, 0); X31 ← stackRest; unwind:→ 293
 103: D45 ← double[](TState.fnResultBytes(X0, 0), 0);
 104: TState.clearResultTemplates(X0);
 105: test X31 == null; T:→ 108
 106: X47 ← newStackEntry(⟦sample_bench_2.r8t+2:62_16 distance5 = dist(pt, _t0) ∥ centroids=[[0, 0, 0], [0.6, 0, 0], [0, 0.6, 0], [0, 0, 0.6], [0.55, 0.55, 0.55], [0.2, 0.2, 0], [0.2, 0, 0.2], [0, 0.2, 0.2], [0.1, 0.1, 0.3], [0.3, 0.1, 0.1], [0.1, 0.3, 0.1]], keep=I4, b0=D32, b1=D34, b2=D36, b3=I40, pt=[D32, D34, D36], distance0=D27, distance1=D29, distance2=D38, distance3=D41, distance4=D43⟧);
 107: X26 ← TState.fillStackEntry(X0, X31, X47, ⟨x0:*@xxxx⟩, mMemo_h115@xxxx, X26);
-108: [d0] ← dist_2(X0, D32, D34, D36, 0.2, 0, 0.2); X31 ← stackRest; unwind:→ 291
 109: D47 ← double[](TState.fnResultBytes(X0, 0), 0);
 110: TState.clearResultTemplates(X0);
 111: test X31 == null; T:→ 114
 112: X49 ← newStackEntry(⟦sample_bench_2.r8t+2:63_18 distance6 = dist(pt, _t0) ∥ centroids=[[0, 0, 0], [0.6, 0, 0], [0, 0.6, 0], [0, 0, 0.6], [0.55, 0.55, 0.55], [0.2, 0.2, 0], [0.2, 0, 0.2], [0, 0.2, 0.2], [0.1, 0.1, 0.3], [0.3, 0.1, 0.1], [0.1, 0.3, 0.1]], keep=I4, b0=D32, b1=D34, b2=D36, b3=I40, pt=[D32, D34, D36], distance0=D27, distance1=D29, distance2=D38, distance3=D41, distance4=D43, distance5=D45⟧);
 113: X26 ← TState.fillStackEntry(X0, X31, X49, ⟨x0:*@xxxx⟩, mMemo_h115@xxxx, X26);
-114: [d0] ← dist_2(X0, D32, D34, D36, 0, 0.2, 0.2); X31 ← stackRest; unwind:→ 289
 115: D49 ← double[](TState.fnResultBytes(X0, 0), 0);
 116: TState.clearResultTemplates(X0);
 117: test X31 == null; T:→ 120
 118: X51 ← newStackEntry(⟦sample_bench_2.r8t+2:64_20 distance7 = dist(pt, _t0) ∥ centroids=[[0, 0, 0], [0.6, 0, 0], [0, 0.6, 0], [0, 0, 0.6], [0.55, 0.55, 0.55], [0.2, 0.2, 0], [0.2, 0, 0.2], [0, 0.2, 0.2], [0.1, 0.1, 0.3], [0.3, 0.1, 0.1], [0.1, 0.3, 0.1]], keep=I4, b0=D32, b1=D34, b2=D36, b3=I40, pt=[D32, D34, D36], distance0=D27, distance1=D29, distance2=D38, distance3=D41, distance4=D43, distance5=D45, distance6=D47⟧);
 119: X26 ← TState.fillStackEntry(X0, X31, X51, ⟨x0:*@xxxx⟩, mMemo_h115@xxxx, X26);
-120: [d0] ← dist_2(X0, D32, D34, D36, 0.1, 0.1, 0.3); X31 ← stackRest; unwind:→ 287
 121: D51 ← double[](TState.fnResultBytes(X0, 0), 0);
 122: TState.clearResultTemplates(X0);
 123: test X31 == null; T:→ 126
 124: X53 ← newStackEntry(⟦sample_bench_2.r8t+2:65_22 distance8 = dist(pt, _t0) ∥ centroids=[[0, 0, 0], [0.6, 0, 0], [0, 0.6, 0], [0, 0, 0.6], [0.55, 0.55, 0.55], [0.2, 0.2, 0], [0.2, 0, 0.2], [0, 0.2, 0.2], [0.1, 0.1, 0.3], [0.3, 0.1, 0.1], [0.1, 0.3, 0.1]], keep=I4, b0=D32, b1=D34, b2=D36, b3=I40, pt=[D32, D34, D36], distance0=D27, distance1=D29, distance2=D38, distance3=D41, distance4=D43, distance5=D45, distance6=D47, distance7=D49⟧);
 125: X26 ← TState.fillStackEntry(X0, X31, X53, ⟨x0:*@xxxx⟩, mMemo_h115@xxxx, X26);
-126: [d0] ← dist_2(X0, D32, D34, D36, 0.3, 0.1, 0.1); X31 ← stackRest; unwind:→ 285
 127: D53 ← double[](TState.fnResultBytes(X0, 0), 0);
 128: TState.clearResultTemplates(X0);
 129: test X31 == null; T:→ 132
 130: X55 ← newStackEntry(⟦sample_bench_2.r8t+2:66_24 distance9 = dist(pt, _t0) ∥ centroids=[[0, 0, 0], [0.6, 0, 0], [0, 0.6, 0], [0, 0, 0.6], [0.55, 0.55, 0.55], [0.2, 0.2, 0], [0.2, 0, 0.2], [0, 0.2, 0.2], [0.1, 0.1, 0.3], [0.3, 0.1, 0.1], [0.1, 0.3, 0.1]], keep=I4, b0=D32, b1=D34, b2=D36, b3=I40, pt=[D32, D34, D36], distance0=D27, distance1=D29, distance2=D38, distance3=D41, distance4=D43, distance5=D45, distance6=D47, distance7=D49, distance8=D51⟧);
 131: X26 ← TState.fillStackEntry(X0, X31, X55, ⟨x0:*@xxxx⟩, mMemo_h115@xxxx, X26);
-132: [d0] ← dist_2(X0, D32, D34, D36, 0.1, 0.3, 0.1); X31 ← stackRest; unwind:→ 283
 133: D55 ← double[](TState.fnResultBytes(X0, 0), 0);
 134: TState.clearResultTemplates(X0);
 135: test X31 == null; T:→ 138
 136: X57 ← newStackEntry(⟦sample_bench_2.r8t+2:67_26 distance10 = dist(pt, _t0) ∥ keep=I4, b0=D32, b1=D34, b2=D36, b3=I40, distance0=D27, distance1=D29, distance2=D38, distance3=D41, distance4=D43, distance5=D45, distance6=D47, distance7=D49, distance8=D51, distance9=D53⟧);
 137: X26 ← TState.fillStackEntry(X0, X31, X57, ⟨x0:*@xxxx⟩, mMemo_h115@xxxx, X26);
-138: I31 ← 0;
 139: D58 ← 0;
 140: I60 ← 0;
 141: I57 ← 1;
=142: I61 ← iAdd(I31, 1);
 143: test I31 == 0; F:→ 190
 144: D62 ← D27;
 145: I31 ← 0;
=146: test I57 1 (< 2); T:→ 148
 147: test D62 < D58; F:→ 150
-148: D58 ← D62;
 149: I60 ← I31;
-150: I31 ← I61;
 151: I57 ← 0;
 152: test I31 < 11; T:→ 142
 153: test I4 == 0; T:→ 267
 154: I31 ← Math.floorMod(I40, I4);
 155: X57 ← RecordLayout.alloc(*{b0: d4, b1: d12, b2: d20, b3: i0, class: b28, distance0: d36, distance1: d44, distance10: d52, distance2: d60, distance3: d68, distance4: d76, distance5: d84, distance6: d92, distance7: d100, distance8: d108, distance9: d116, filter: i32}@xxxx, X0, 0);
 156: Frame7i2x.d0.set(X57, D32);
 157: Frame7i2x.d1.set(X57, D34);
 158: Frame7i2x.d2.set(X57, D36);
 159: Frame7i2x.i0.set(X57, I40);
 160: test I60 isUint8; F:→ 282
 161: setUint8[](Frame7i2x.x0(X57), 0, I60);
 162: setDouble[](Frame7i2x.x0(X57), 8, D27);
 163: setDouble[](Frame7i2x.x0(X57), 16, D29);
 164: setDouble[](Frame7i2x.x0(X57), 24, D55);
 165: setDouble[](Frame7i2x.x0(X57), 32, D38);
 166: setDouble[](Frame7i2x.x0(X57), 40, D41);
 167: setDouble[](Frame7i2x.x0(X57), 48, D43);
 168: setDouble[](Frame7i2x.x0(X57), 56, D45);
 169: setDouble[](Frame7i2x.x0(X57), 64, D47);
 170: setDouble[](Frame7i2x.x0(X57), 72, D49);
 171: setDouble[](Frame7i2x.x0(X57), 80, D51);
 172: setDouble[](Frame7i2x.x0(X57), 88, D53);
 173: setInt[](Frame7i2x.x0(X57), 4, I31);
 174: test X26 == null; T:→ 180
 175: X26 ← TState.fillStackEntry(X0, X26, ⟦sample_bench_2.r8t+2:28_1 _t0 = classify(f, centroids, keep)⟧, ⟨x0:*@xxxx, Filter(lambda@29:18)⟩, mMemo_h39@xxxx, null);
 176: test X26 == null; T:→ 180
 177: X26 ← TState.fillStackEntry(X0, X26, ⟦CollectionCore.AtTransformed.afterAt⟧, ⟨x0:*@xxxx, Filter(lambda@29:18)⟩, mMemo_h45@xxxx, null);
 178: test X26 == null; T:→ 180
 179: X20 ← TState.fillStackEntry(X0, X26, ⟦CollectionCore.AtTransformed.at ∥ second=Filter(lambda@29:18)⟧, ⟨⸨Absent; x0:*@xxxx⸩, Undef, BaseIterator(EnumerateValues, [b0, b0], [b0, b0]), TransformedIterator((empty), EnumerateValues, TransformedLambda(TransformedLambda(lambda@19:24⸨img={b0: lambda@37:11⸨xc=d0, yc=d0, scale=d0⸩, b1: lambda@37:11⸨xc=d0, yc=d0, scale=d0⸩, b2: lambda@37:11⸨xc=d0, yc=d0, scale=d0⸩, b3: lambda@14:14⸨size=b0⸩}⸩, lambda@28:11⸨centroids=[[0, 0, 0], [0.6, 0, 0], [0, 0.6, 0], [0, 0, 0.6], [0.55, 0.55, 0.55], [0.2, 0.2, 0], [0.2, 0, 0.2], [0, 0.2, 0.2], [0.1, 0.1, 0.3], [0.3, 0.1, 0.1], [0.1, 0.3, 0.1]], keep=i0⸩), Filter(lambda@29:18)))⟩, mMemo_h42@xxxx, null);
-180: test X57 is *{b0: d4, b1: d12, b2: d20, b3: i0, class: b28, distance0: d36, distance1: d44, distance10: d52, distance2: d60, distance3: d68, distance4: d76, distance5: d84, distance6: d92, distance7: d100, distance8: d108, distance9: d116, filter: i32}@xxxx; F:→ 265
 181: test int[](Frame7i2x.x0(X57), 4) == 0; T:→ 184
 182: dropRef{X57};
 183: X57 ← Absent;
-184: test X20 == null; T:→ 187
 185: X26 ← newStackEntry(⟦CollectionCore.NextTransformedIterator.at ∥ key=Undef, innerIt=BaseIterator(EnumerateValues, [I23, I24], [I1, I1]), it=TransformedIterator((empty), EnumerateValues, TransformedLambda(TransformedLambda(lambda@19:24⸨img={b0: lambda@37:11⸨xc=D7, yc=D9, scale=D5⸩, b1: lambda@37:11⸨xc=D11, yc=D13, scale=D5⸩, b2: lambda@37:11⸨xc=D15, yc=D17, scale=D5⸩, b3: lambda@14:14⸨size=I1⸩}⸩, lambda@28:11⸨centroids=[[0, 0, 0], [0.6, 0, 0], [0, 0.6, 0], [0, 0, 0.6], [0.55, 0.55, 0.55], [0.2, 0.2, 0], [0.2, 0, 0.2], [0, 0.2, 0.2], [0.1, 0.1, 0.3], [0.3, 0.1, 0.1], [0.1, 0.3, 0.1]], keep=I4⸩), Filter(lambda@29:18)))⟧);
 186: X19 ← TState.fillStackEntry(X0, X20, X26, ⟨⸨Absent; x0:*@xxxx⸩, TransformedIterator(BaseIterator(EnumerateValues, [b0, b0], [b0, b0]), EnumerateValues, TransformedLambda(TransformedLambda(lambda@19:24⸨img={b0: lambda@37:11⸨xc=d0, yc=d0, scale=d0⸩, b1: lambda@37:11⸨xc=d0, yc=d0, scale=d0⸩, b2: lambda@37:11⸨xc=d0, yc=d0, scale=d0⸩, b3: lambda@14:14⸨size=b0⸩}⸩, lambda@28:11⸨centroids=[[0, 0, 0], [0.6, 0, 0], [0, 0.6, 0], [0, 0, 0.6], [0.55, 0.55, 0.55], [0.2, 0.2, 0], [0.2, 0, 0.2], [0, 0.2, 0.2], [0.1, 0.1, 0.3], [0.3, 0.1, 0.1], [0.1, 0.3, 0.1]], keep=i0⸩), Filter(lambda@29:18))), SaveUnordered, x0:*[]@xxxx⟩, mMemo_h39@xxxx, X19);
-187: test X57 instanceof Frame; T:→ 221
 188: dropRef{X57};
 189: I21 ← I24; → 61
-190: test I31 == 1; F:→ 193
 191: D62 ← D29;
 192: I31 ← 1; → 146
-193: test I31 == 2; F:→ 196
 194: D62 ← D38;
 195: I31 ← 2; → 146
-196: test I31 == 3; F:→ 199
 197: D62 ← D41;
 198: I31 ← 3; → 146
-199: test I31 == 4; F:→ 202
 200: D62 ← D43;
 201: I31 ← 4; → 146
-202: test I31 == 5; F:→ 205
 203: D62 ← D45;
 204: I31 ← 5; → 146
-205: test I31 == 6; F:→ 208
 206: D62 ← D47;
 207: I31 ← 6; → 146
-208: test I31 == 7; F:→ 211
 209: D62 ← D49;
 210: I31 ← 7; → 146
-211: test I31 == 8; F:→ 214
 212: D62 ← D51;
 213: I31 ← 8; → 146
-214: test I31 == 9; F:→ 217
 215: D62 ← D53;
 216: I31 ← 9; → 146
-217: D62 ← D55;
 218: I31 ← 10; → 146
-219: I25 ← I23;
 220: X57 ← Absent;
-221: test X19 == null; T:→ 224
 222: addRef(X22); X20 ← newStackEntry(⟦LoopCore.Iterate.next ∥ loop=SaveUnordered, state=X22⟧);
 223: X3 ← TState.fillStackEntry(X0, X19, X20, ⟨x0:*[]@xxxx, SaveUnordered⟩, mMemo_h41@xxxx, X3);
-224: test X57 instanceof Frame; F:→ 236
 225: I19 ← Frame1i2x.i0(X22);
 226: test TState.reserveForChange(X0, *[]x0:*@xxxx@xxxx, X22, iAdd(I19, 1)) == 0; T:→ 263
 227: X20 ← removeRange*[]x0:*@xxxx@xxxx(X0, addRef(X22), I19, 0, 1);
 228: test X57 instanceof Frame; F:→ 262
 229: test X57 is *{b0: d4, b1: d12, b2: d20, b3: i0, class: b28, distance0: d36, distance1: d44, distance10: d52, distance2: d60, distance3: d68, distance4: d76, distance5: d84, distance6: d92, distance7: d100, distance8: d108, distance9: d116, filter: i32}@xxxx; F:→ 262
 230: dropRef{X22};
 231: clear*[]x0:*@xxxx@xxxx(X0, X20, I19, iAdd(I19, 1));
 232: setObject[](Frame1i2x.x0(X20), I19, addRef(X57));
 233: test I25 == 1; F:→ 254
 234: dropRef{X57};
 235: X22 ← X20; → 59
-236: test X3 == null; T:→ 240
 237: X3 ← TState.fillStackEntry(X0, X3, ⟦LoopCore.PipeCollectionCollector.iterate ∥ loop=SaveUnordered⟧, ⟨x0:*[]@xxxx⟩, mMemo_h42@xxxx, null);
 238: test X3 == null; T:→ 240
 239: X2 ← TState.fillStackEntry(X0, X3, ⟦sample_bench_2.r8t+2:27_21 filtered = pipe(_t0, _t1)⟧, ⟨{count: b0, last: x0:*@xxxx}⟩, mMemo_x@xxxx, null);
-240: I19 ← Frame1i2x.i0(X22);
 241: X3 ← null;
 242: test I19 < 1; T:→ 263
 243: test Frame1i2x.i0(X22) < I19; T:→ 263
 244: dropRef{X57};
 245: I1 ← Frame1i2x.i0(X22);
 246: X3 ← Value.fromArray(Frame1i2x.x0(X22), iSub(I19, 1));
 247: addRef{X3} dropRef{X22};
 248: TState.setResultTemplates(X0, [{count: i0, last: x0:*@xxxx}]);
 249: X4 ← TState.fnResults(X0, 1);
 250: setInt[](TState.fnResultBytes(X0, 4), 0, I1);
 251: setObject[](X4, 0, X3);
 252: TState.setStackRest(X0, X2);
 253: return
-254: X22 ← newStackEntry(⟦ReducerCore.NextStateSaveUnordered.replace ∥ state=X20, index=I19, value=X57⟧);
 255: X19 ← TState.fillStackEntry(X0, null, X22, ⟨x0:*[]@xxxx, SaveUnordered, TransformedIterator(BaseIterator(EnumerateValues, [1, b0], [b0, b0]), EnumerateValues, TransformedLambda(TransformedLambda(lambda@19:24⸨img={b0: lambda@37:11⸨xc=d0, yc=d0, scale=d0⸩, b1: lambda@37:11⸨xc=d0, yc=d0, scale=d0⸩, b2: lambda@37:11⸨xc=d0, yc=d0, scale=d0⸩, b3: lambda@14:14⸨size=b0⸩}⸩, lambda@28:11⸨centroids=[[0, 0, 0], [0.6, 0, 0], [0, 0.6, 0], [0, 0, 0.6], [0.55, 0.55, 0.55], [0.2, 0.2, 0], [0.2, 0, 0.2], [0, 0.2, 0.2], [0.1, 0.1, 0.3], [0.3, 0.1, 0.1], [0.1, 0.3, 0.1]], keep=i0⸩), Filter(lambda@29:18)))⟩, mMemo_1@xxxx, null);
 256: X20 ← newStackEntry(⟦LoopCore.Iterate.nextState ∥ loop=SaveUnordered, it=TransformedIterator(BaseIterator(EnumerateValues, [I25, I21], [I1, I1]), EnumerateValues, TransformedLambda(TransformedLambda(lambda@19:24⸨img={b0: lambda@37:11⸨xc=D7, yc=D9, scale=D5⸩, b1: lambda@37:11⸨xc=D11, yc=D13, scale=D5⸩, b2: lambda@37:11⸨xc=D15, yc=D17, scale=D5⸩, b3: lambda@14:14⸨size=I1⸩}⸩, lambda@28:11⸨centroids=[[0, 0, 0], [0.6, 0, 0], [0, 0.6, 0], [0, 0, 0.6], [0.55, 0.55, 0.55], [0.2, 0.2, 0], [0.2, 0, 0.2], [0, 0.2, 0.2], [0.1, 0.1, 0.3], [0.3, 0.1, 0.1], [0.1, 0.3, 0.1]], keep=I4⸩), Filter(lambda@29:18)))⟧);
 257: X3 ← TState.fillStackEntry(X0, X19, X20, ⟨x0:*[]@xxxx, SaveUnordered⟩, mMemo_h41@xxxx, X3);
=258: X3 ← TState.fillStackEntry(X0, X3, ⟦LoopCore.PipeCollectionCollector.iterate ∥ loop=SaveUnordered⟧, ⟨x0:*[]@xxxx⟩, mMemo_h42@xxxx, null);
 259: X2 ← TState.fillStackEntry(X0, X3, ⟦sample_bench_2.r8t+2:27_21 filtered = pipe(_t0, _t1)⟧, ⟨{count: b0, last: x0:*@xxxx}⟩, mMemo_x@xxxx, X2);
=260: TState.setStackRest(X0, X2);
 261: return
-262: dropRef{X20};
-263: X19 ← newStackEntry(⟦LoopCore.Iterate.afterNext ∥ element=⸨Absent; X57⸩, it=TransformedIterator(BaseIterator(EnumerateValues, [I25, I21], [I1, I1]), EnumerateValues, TransformedLambda(TransformedLambda(lambda@19:24⸨img={b0: lambda@37:11⸨xc=D7, yc=D9, scale=D5⸩, b1: lambda@37:11⸨xc=D11, yc=D13, scale=D5⸩, b2: lambda@37:11⸨xc=D15, yc=D17, scale=D5⸩, b3: lambda@14:14⸨size=I1⸩}⸩, lambda@28:11⸨centroids=[[0, 0, 0], [0.6, 0, 0], [0, 0.6, 0], [0, 0, 0.6], [0.55, 0.55, 0.55], [0.2, 0.2, 0], [0.2, 0, 0.2], [0, 0.2, 0.2], [0.1, 0.1, 0.3], [0.3, 0.1, 0.1], [0.1, 0.3, 0.1]], keep=I4⸩), Filter(lambda@29:18))), loop=SaveUnordered, state=X22⟧);
 264: X3 ← TState.fillStackEntry(X0, null, X19, ⟨x0:*[]@xxxx, SaveUnordered⟩, mMemo_h41@xxxx, X3); → 258
-265: dropRef{X57};
 266: X26 ← null;
=267: X21 ← newStackEntry(⟦ArrayCore.NextArrayIterator.startLoop ∥ index=11, it=ArrayIterator([[D27, 0], [D29, 1], [D38, 2], [D41, 3], [D43, 4], [D45, 5], [D47, 6], [D49, 7], [D51, 8], [D53, 9], [D55, 10]], EnumerateValues, 11)⟧);
 268: X21 ← TState.fillStackEntry(X0, null, X21, ⟨⸨[d0, b0]; Absent⸩, ArrayIterator([[d0, 0], [d0, 1], [d0, 2], [d0, 3], [d0, 4], [d0, 5], [d0, 6], [d0, 7], [d0, 8], [d0, 9], [d0, 10]], EnumerateValues, b0), Top(ElementLessThan([1]), False), ⸨[d0, b0]; Absent⸩⟩, mMemo_1@xxxx, null);
 269: X25 ← newStackEntry(⟦LoopCore.Iterate.next ∥ loop=Top(ElementLessThan([1]), False), state=[D58, I60]⟧);
 270: X21 ← TState.fillStackEntry(X0, X21, X25, ⟨[d0, b0], Top(ElementLessThan([1]), False)⟩, mMemo_10@xxxx, null);
 271: X31 ← TState.fillStackEntry(X0, X21, ⟦LoopCore.enumerateDefault⟧, ⟨[d0, b0], Top(ElementLessThan([1]), False)⟩, mMemo_11@xxxx, null);
 272: X31 ← TState.fillStackEntry(X0, X31, ⟦LoopCore.PipeCollectionCollector.enumerate ∥ loop=Top(ElementLessThan([1]), False)⟧, ⟨[d0, b0]⟩, mMemo_15@xxxx, null);
 273: X21 ← newStackEntry(⟦sample_bench_2.r8t+2:79_29 min = pipe(distances, _t0) ∥ keep=I4, b0=D32, b1=D34, b2=D36, b3=I40, distance0=D27, distance1=D29, distance2=D38, distance3=D41, distance4=D43, distance5=D45, distance6=D47, distance7=D49, distance8=D51, distance9=D53, distance10=D55⟧);
 274: X26 ← TState.fillStackEntry(X0, X31, X21, ⟨x0:*@xxxx⟩, mMemo_h115@xxxx, X26);
=275: X26 ← TState.fillStackEntry(X0, X26, ⟦sample_bench_2.r8t+2:28_1 _t0 = classify(f, centroids, keep)⟧, ⟨x0:*@xxxx, Filter(lambda@29:18)⟩, mMemo_h39@xxxx, null);
 276: X26 ← TState.fillStackEntry(X0, X26, ⟦CollectionCore.AtTransformed.afterAt⟧, ⟨x0:*@xxxx, Filter(lambda@29:18)⟩, mMemo_h45@xxxx, null);
 277: X20 ← TState.fillStackEntry(X0, X26, ⟦CollectionCore.AtTransformed.at ∥ second=Filter(lambda@29:18)⟧, ⟨⸨Absent; x0:*@xxxx⸩, Undef, BaseIterator(EnumerateValues, [b0, b0], [b0, b0]), TransformedIterator((empty), EnumerateValues, TransformedLambda(TransformedLambda(lambda@19:24⸨img={b0: lambda@37:11⸨xc=d0, yc=d0, scale=d0⸩, b1: lambda@37:11⸨xc=d0, yc=d0, scale=d0⸩, b2: lambda@37:11⸨xc=d0, yc=d0, scale=d0⸩, b3: lambda@14:14⸨size=b0⸩}⸩, lambda@28:11⸨centroids=[[0, 0, 0], [0.6, 0, 0], [0, 0.6, 0], [0, 0, 0.6], [0.55, 0.55, 0.55], [0.2, 0.2, 0], [0.2, 0, 0.2], [0, 0.2, 0.2], [0.1, 0.1, 0.3], [0.3, 0.1, 0.1], [0.1, 0.3, 0.1]], keep=i0⸩), Filter(lambda@29:18)))⟩, mMemo_h42@xxxx, X20);
 278: X21 ← newStackEntry(⟦CollectionCore.NextTransformedIterator.at ∥ key=Undef, innerIt=BaseIterator(EnumerateValues, [I23, I24], [I1, I1]), it=TransformedIterator((empty), EnumerateValues, TransformedLambda(TransformedLambda(lambda@19:24⸨img={b0: lambda@37:11⸨xc=D7, yc=D9, scale=D5⸩, b1: lambda@37:11⸨xc=D11, yc=D13, scale=D5⸩, b2: lambda@37:11⸨xc=D15, yc=D17, scale=D5⸩, b3: lambda@14:14⸨size=I1⸩}⸩, lambda@28:11⸨centroids=[[0, 0, 0], [0.6, 0, 0], [0, 0.6, 0], [0, 0, 0.6], [0.55, 0.55, 0.55], [0.2, 0.2, 0], [0.2, 0, 0.2], [0, 0.2, 0.2], [0.1, 0.1, 0.3], [0.3, 0.1, 0.1], [0.1, 0.3, 0.1]], keep=I4⸩), Filter(lambda@29:18)))⟧);
 279: X19 ← TState.fillStackEntry(X0, X20, X21, ⟨⸨Absent; x0:*@xxxx⸩, TransformedIterator(BaseIterator(EnumerateValues, [b0, b0], [b0, b0]), EnumerateValues, TransformedLambda(TransformedLambda(lambda@19:24⸨img={b0: lambda@37:11⸨xc=d0, yc=d0, scale=d0⸩, b1: lambda@37:11⸨xc=d0, yc=d0, scale=d0⸩, b2: lambda@37:11⸨xc=d0, yc=d0, scale=d0⸩, b3: lambda@14:14⸨size=b0⸩}⸩, lambda@28:11⸨centroids=[[0, 0, 0], [0.6, 0, 0], [0, 0.6, 0], [0, 0, 0.6], [0.55, 0.55, 0.55], [0.2, 0.2, 0], [0.2, 0, 0.2], [0, 0.2, 0.2], [0.1, 0.1, 0.3], [0.3, 0.1, 0.1], [0.1, 0.3, 0.1]], keep=i0⸩), Filter(lambda@29:18))), SaveUnordered, x0:*[]@xxxx⟩, mMemo_h39@xxxx, X19);
 280: X1 ← newStackEntry(⟦LoopCore.Iterate.next ∥ loop=SaveUnordered, state=X22⟧);
 281: X3 ← TState.fillStackEntry(X0, X19, X1, ⟨x0:*[]@xxxx, SaveUnordered⟩, mMemo_h41@xxxx, X3); → 258
-282: dropRef{X57}; → 267
-283: X21 ← newStackEntry(⟦sample_bench_2.r8t+2:67_26 distance10 = dist(pt, _t0) ∥ keep=I4, b0=D32, b1=D34, b2=D36, b3=I40, distance0=D27, distance1=D29, distance2=D38, distance3=D41, distance4=D43, distance5=D45, distance6=D47, distance7=D49, distance8=D51, distance9=D53⟧);
 284: X26 ← TState.fillStackEntry(X0, X31, X21, ⟨x0:*@xxxx⟩, mMemo_h115@xxxx, X26); → 275
-285: X21 ← newStackEntry(⟦sample_bench_2.r8t+2:66_24 distance9 = dist(pt, _t0) ∥ centroids=[[0, 0, 0], [0.6, 0, 0], [0, 0.6, 0], [0, 0, 0.6], [0.55, 0.55, 0.55], [0.2, 0.2, 0], [0.2, 0, 0.2], [0, 0.2, 0.2], [0.1, 0.1, 0.3], [0.3, 0.1, 0.1], [0.1, 0.3, 0.1]], keep=I4, b0=D32, b1=D34, b2=D36, b3=I40, pt=[D32, D34, D36], distance0=D27, distance1=D29, distance2=D38, distance3=D41, distance4=D43, distance5=D45, distance6=D47, distance7=D49, distance8=D51⟧);
 286: X26 ← TState.fillStackEntry(X0, X31, X21, ⟨x0:*@xxxx⟩, mMemo_h115@xxxx, X26); → 275
-287: X21 ← newStackEntry(⟦sample_bench_2.r8t+2:65_22 distance8 = dist(pt, _t0) ∥ centroids=[[0, 0, 0], [0.6, 0, 0], [0, 0.6, 0], [0, 0, 0.6], [0.55, 0.55, 0.55], [0.2, 0.2, 0], [0.2, 0, 0.2], [0, 0.2, 0.2], [0.1, 0.1, 0.3], [0.3, 0.1, 0.1], [0.1, 0.3, 0.1]], keep=I4, b0=D32, b1=D34, b2=D36, b3=I40, pt=[D32, D34, D36], distance0=D27, distance1=D29, distance2=D38, distance3=D41, distance4=D43, distance5=D45, distance6=D47, distance7=D49⟧);
 288: X26 ← TState.fillStackEntry(X0, X31, X21, ⟨x0:*@xxxx⟩, mMemo_h115@xxxx, X26); → 275
-289: X21 ← newStackEntry(⟦sample_bench_2.r8t+2:64_20 distance7 = dist(pt, _t0) ∥ centroids=[[0, 0, 0], [0.6, 0, 0], [0, 0.6, 0], [0, 0, 0.6], [0.55, 0.55, 0.55], [0.2, 0.2, 0], [0.2, 0, 0.2], [0, 0.2, 0.2], [0.1, 0.1, 0.3], [0.3, 0.1, 0.1], [0.1, 0.3, 0.1]], keep=I4, b0=D32, b1=D34, b2=D36, b3=I40, pt=[D32, D34, D36], distance0=D27, distance1=D29, distance2=D38, distance3=D41, distance4=D43, distance5=D45, distance6=D47⟧);
 290: X26 ← TState.fillStackEntry(X0, X31, X21, ⟨x0:*@xxxx⟩, mMemo_h115@xxxx, X26); → 275
-291: X21 ← newStackEntry(⟦sample_bench_2.r8t+2:63_18 distance6 = dist(pt, _t0) ∥ centroids=[[0, 0, 0], [0.6, 0, 0], [0, 0.6, 0], [0, 0, 0.6], [0.55, 0.55, 0.55], [0.2, 0.2, 0], [0.2, 0, 0.2], [0, 0.2, 0.2], [0.1, 0.1, 0.3], [0.3, 0.1, 0.1], [0.1, 0.3, 0.1]], keep=I4, b0=D32, b1=D34, b2=D36, b3=I40, pt=[D32, D34, D36], distance0=D27, distance1=D29, distance2=D38, distance3=D41, distance4=D43, distance5=D45⟧);
 292: X26 ← TState.fillStackEntry(X0, X31, X21, ⟨x0:*@xxxx⟩, mMemo_h115@xxxx, X26); → 275
-293: X21 ← newStackEntry(⟦sample_bench_2.r8t+2:62_16 distance5 = dist(pt, _t0) ∥ centroids=[[0, 0, 0], [0.6, 0, 0], [0, 0.6, 0], [0, 0, 0.6], [0.55, 0.55, 0.55], [0.2, 0.2, 0], [0.2, 0, 0.2], [0, 0.2, 0.2], [0.1, 0.1, 0.3], [0.3, 0.1, 0.1], [0.1, 0.3, 0.1]], keep=I4, b0=D32, b1=D34, b2=D36, b3=I40, pt=[D32, D34, D36], distance0=D27, distance1=D29, distance2=D38, distance3=D41, distance4=D43⟧);
 294: X26 ← TState.fillStackEntry(X0, X31, X21, ⟨x0:*@xxxx⟩, mMemo_h115@xxxx, X26); → 275
-295: X21 ← newStackEntry(⟦sample_bench_2.r8t+2:61_14 distance4 = dist(pt, _t0) ∥ centroids=[[0, 0, 0], [0.6, 0, 0], [0, 0.6, 0], [0, 0, 0.6], [0.55, 0.55, 0.55], [0.2, 0.2, 0], [0.2, 0, 0.2], [0, 0.2, 0.2], [0.1, 0.1, 0.3], [0.3, 0.1, 0.1], [0.1, 0.3, 0.1]], keep=I4, b0=D32, b1=D34, b2=D36, b3=I40, pt=[D32, D34, D36], distance0=D27, distance1=D29, distance2=D38, distance3=D41⟧);
 296: X26 ← TState.fillStackEntry(X0, X31, X21, ⟨x0:*@xxxx⟩, mMemo_h115@xxxx, X26); → 275
-297: X21 ← newStackEntry(⟦sample_bench_2.r8t+2:60_12 distance3 = dist(pt, _t0) ∥ centroids=[[0, 0, 0], [0.6, 0, 0], [0, 0.6, 0], [0, 0, 0.6], [0.55, 0.55, 0.55], [0.2, 0.2, 0], [0.2, 0, 0.2], [0, 0.2, 0.2], [0.1, 0.1, 0.3], [0.3, 0.1, 0.1], [0.1, 0.3, 0.1]], keep=I4, b0=D32, b1=D34, b2=D36, b3=I40, pt=[D32, D34, D36], distance0=D27, distance1=D29, distance2=D38⟧);
 298: X26 ← TState.fillStackEntry(X0, X31, X21, ⟨x0:*@xxxx⟩, mMemo_h115@xxxx, X26); → 275
-299: X21 ← newStackEntry(⟦sample_bench_2.r8t+2:59_10 distance2 = dist(pt, _t0) ∥ centroids=[[0, 0, 0], [0.6, 0, 0], [0, 0.6, 0], [0, 0, 0.6], [0.55, 0.55, 0.55], [0.2, 0.2, 0], [0.2, 0, 0.2], [0, 0.2, 0.2], [0.1, 0.1, 0.3], [0.3, 0.1, 0.1], [0.1, 0.3, 0.1]], keep=I4, b0=D32, b1=D34, b2=D36, b3=I40, pt=[D32, D34, D36], distance0=D27, distance1=D29⟧);
 300: X26 ← TState.fillStackEntry(X0, X31, X21, ⟨x0:*@xxxx⟩, mMemo_h115@xxxx, X26); → 275
-301: X21 ← newStackEntry(⟦sample_bench_2.r8t+2:58_8 distance1 = dist(pt, _t0) ∥ centroids=[[0, 0, 0], [0.6, 0, 0], [0, 0.6, 0], [0, 0, 0.6], [0.55, 0.55, 0.55], [0.2, 0.2, 0], [0.2, 0, 0.2], [0, 0.2, 0.2], [0.1, 0.1, 0.3], [0.3, 0.1, 0.1], [0.1, 0.3, 0.1]], keep=I4, b0=D32, b1=D34, b2=D36, b3=I40, pt=[D32, D34, D36], distance0=D27⟧);
 302: X26 ← TState.fillStackEntry(X0, X31, X21, ⟨x0:*@xxxx⟩, mMemo_h115@xxxx, X26); → 275
-303: X21 ← newStackEntry(⟦sample_bench_2.r8t+2:57_6 distance0 = dist(pt, _t0) ∥ centroids=[[0, 0, 0], [0.6, 0, 0], [0, 0.6, 0], [0, 0, 0.6], [0.55, 0.55, 0.55], [0.2, 0.2, 0], [0.2, 0, 0.2], [0, 0.2, 0.2], [0.1, 0.1, 0.3], [0.3, 0.1, 0.1], [0.1, 0.3, 0.1]], keep=I4, b0=D32, b1=D34, b2=D36, b3=I40, pt=[D32, D34, D36]⟧);
 304: X26 ← TState.fillStackEntry(X0, X31, X21, ⟨x0:*@xxxx⟩, mMemo_h115@xxxx, X26); → 275
-305: X21 ← newStackEntry(⟦ArrayCore.NextArrayIterator.startLoop ∥ index=2, it=ArrayIterator([D27, D29], EnumerateAllKeys, 2)⟧);
 306: X21 ← TState.fillStackEntry(X0, null, X21, ⟨⸨[[b0], d0]; Absent⸩, ArrayIterator([d0, d0], EnumerateAllKeys, b0), SaverLoop(SaveElements), [d0, d0]⟩, mMemo_1@xxxx, null);
 307: X25 ← newStackEntry(⟦LoopCore.Iterate.next ∥ loop=SaverLoop(SaveElements), state=[D38, D41]⟧);
 308: X21 ← TState.fillStackEntry(X0, X21, X25, ⟨[d0, d0], SaverLoop(SaveElements)⟩, mMemo_6@xxxx, null);
 309: X21 ← TState.fillStackEntry(X0, X21, ⟦LoopCore.enumerateDefault⟧, ⟨[d0, d0], SaverLoop(SaveElements)⟩, mMemo_7@xxxx, null);
 310: X21 ← TState.fillStackEntry(X0, X21, ⟦LoopCore.PipeCollectionCollector.enumerate ∥ loop=SaverLoop(SaveElements)⟧, ⟨[d0, d0]⟩, mMemo_13@xxxx, null);
 311: X25 ← newStackEntry(⟦sample_bench_2.r8t+2:47_2 _t0 = pipe(xy, _t0) ∥ b=lambda@14:14⸨size=I1⸩⟧);
 312: X31 ← TState.fillStackEntry(X0, X21, X25, ⟨i0⟩, mMemo_23@xxxx, null);
 313: X31 ← TState.fillStackEntry(X0, X31, ⟦CollectionCore.AtTransformed.afterAt⟧, ⟨i0⟩, mMemo_25@xxxx, null);
 314: X21 ← newStackEntry(⟦sample_bench_2.r8t+2:53_3 b3 = at(f, "b3") ∥ centroids=[[0, 0, 0], [0.6, 0, 0], [0, 0.6, 0], [0, 0, 0.6], [0.55, 0.55, 0.55], [0.2, 0.2, 0], [0.2, 0, 0.2], [0, 0.2, 0.2], [0.1, 0.1, 0.3], [0.3, 0.1, 0.1], [0.1, 0.3, 0.1]], keep=I4, b0=D32, b1=D34, b2=D36⟧);
 315: X26 ← TState.fillStackEntry(X0, X31, X21, ⟨x0:*@xxxx⟩, mMemo_h115@xxxx, X26); → 275
-316: X31 ← TState.fillStackEntry(X0, X31, ⟦CollectionCore.AtTransformed.afterAt⟧, ⟨d0⟩, mMemo_5@xxxx, null);
 317: X21 ← newStackEntry(⟦sample_bench_2.r8t+2:52_2 b2 = at(f, "b2") ∥ f=TransformedCollection({b0: lambda@37:11⸨xc=D7, yc=D9, scale=D5⸩, b1: lambda@37:11⸨xc=D11, yc=D13, scale=D5⸩, b2: lambda@37:11⸨xc=D15, yc=D17, scale=D5⸩, b3: lambda@14:14⸨size=I1⸩}, lambda@47:40⸨xy=[D27, D29]⸩), centroids=[[0, 0, 0], [0.6, 0, 0], [0, 0.6, 0], [0, 0, 0.6], [0.55, 0.55, 0.55], [0.2, 0.2, 0], [0.2, 0, 0.2], [0, 0.2, 0.2], [0.1, 0.1, 0.3], [0.3, 0.1, 0.1], [0.1, 0.3, 0.1]], keep=I4, b0=D32, b1=D34⟧);
 318: X26 ← TState.fillStackEntry(X0, X31, X21, ⟨x0:*@xxxx⟩, mMemo_h115@xxxx, X26); → 275
-319: X31 ← TState.fillStackEntry(X0, X31, ⟦CollectionCore.AtTransformed.afterAt⟧, ⟨d0⟩, mMemo_5@xxxx, null);
 320: X21 ← newStackEntry(⟦sample_bench_2.r8t+2:51_1 b1 = at(f, "b1") ∥ f=TransformedCollection({b0: lambda@37:11⸨xc=D7, yc=D9, scale=D5⸩, b1: lambda@37:11⸨xc=D11, yc=D13, scale=D5⸩, b2: lambda@37:11⸨xc=D15, yc=D17, scale=D5⸩, b3: lambda@14:14⸨size=I1⸩}, lambda@47:40⸨xy=[D27, D29]⸩), centroids=[[0, 0, 0], [0.6, 0, 0], [0, 0.6, 0], [0, 0, 0.6], [0.55, 0.55, 0.55], [0.2, 0.2, 0], [0.2, 0, 0.2], [0, 0.2, 0.2], [0.1, 0.1, 0.3], [0.3, 0.1, 0.1], [0.1, 0.3, 0.1]], keep=I4, b0=D32⟧);
 321: X26 ← TState.fillStackEntry(X0, X31, X21, ⟨x0:*@xxxx⟩, mMemo_h115@xxxx, X26); → 275
-322: X31 ← TState.fillStackEntry(X0, X31, ⟦CollectionCore.AtTransformed.afterAt⟧, ⟨d0⟩, mMemo_5@xxxx, null);
 323: X21 ← newStackEntry(⟦sample_bench_2.r8t+2:50_0 b0 = at(f, "b0") ∥ f=TransformedCollection({b0: lambda@37:11⸨xc=D7, yc=D9, scale=D5⸩, b1: lambda@37:11⸨xc=D11, yc=D13, scale=D5⸩, b2: lambda@37:11⸨xc=D15, yc=D17, scale=D5⸩, b3: lambda@14:14⸨size=I1⸩}, lambda@47:40⸨xy=[D27, D29]⸩), centroids=[[0, 0, 0], [0.6, 0, 0], [0, 0.6, 0], [0, 0, 0.6], [0.55, 0.55, 0.55], [0.2, 0.2, 0], [0.2, 0, 0.2], [0, 0.2, 0.2], [0.1, 0.1, 0.3], [0.3, 0.1, 0.1], [0.1, 0.3, 0.1]], keep=I4⟧);
 324: X26 ← TState.fillStackEntry(X0, X31, X21, ⟨x0:*@xxxx⟩, mMemo_h115@xxxx, null); → 275
-325: X2 ← newStackEntry(⟦sample_bench_2.r8t+2:8_0 keep = multiply(4, size) ∥ size=I1⟧);
 326: X2 ← TState.fillStackEntry(X0, null, X2, ⟨{count: b0, last: x0:*@xxxx}⟩, mMemo_x@xxxx, null); → 260

at_1(lambda@47:40⸨xy=[d1, d2]⸩, lambda@37:11⸨xc=d3, yc=d4, scale=d5⸩):
  1: AtomicInteger.incrementAndGet(0);
  2: I11 ← 0;
  3: D12 ← 0;
= 4: I14 ← iAdd(I11, 1);
  5: test I11 == 0; F:→ 10
  6: D15 ← D1;
= 7: test I14 == 1; F:→ 11
  8: I11 ← 1;
  9: D12 ← D15; → 4
-10: D15 ← D3; → 7
-11: D17 ← dSub(D15, D7);
 12: D19 ← dSub(D12, D5);
 13: D17 ← dDiv(dAdd(dMul(D17, D17), dMul(D19, D19)), D9);
 14: test Double.isNaN(D17) == 0; F:→ 22
 15: D17 ← Math.log(dSub(dAdd(D17, 7), 6));
 16: test Double.isNaN(D17) == 0; F:→ 22
 17: D17 ← dDiv(1, dAdd(D17, 1));
 18: test Double.isNaN(D17) == 0; F:→ 22
 19: TState.setResultTemplates(X0, [d0]);
 20: setDouble[](TState.fnResultBytes(X0, 8), 0, D17);
 21: return
-22: X11 ← newStackEntry(⟦ArrayCore.NextArrayIterator.startLoop ∥ index=2, it=ArrayIterator([D1, D3], EnumerateAllKeys, 2)⟧);
 23: X1 ← TState.fillStackEntry(X0, null, X11, ⟨⸨[[b0], d0]; Absent⸩, ArrayIterator([d0, d0], EnumerateAllKeys, b0), SaverLoop(SaveElements), [d0, d0]⟩, mMemo_1@xxxx, null);
 24: X2 ← newStackEntry(⟦LoopCore.Iterate.next ∥ loop=SaverLoop(SaveElements), state=[D12, D15]⟧);
 25: X1 ← TState.fillStackEntry(X0, X1, X2, ⟨[d0, d0], SaverLoop(SaveElements)⟩, mMemo_6@xxxx, null);
 26: X1 ← TState.fillStackEntry(X0, X1, ⟦LoopCore.enumerateDefault⟧, ⟨[d0, d0], SaverLoop(SaveElements)⟩, mMemo_7@xxxx, null);
 27: X1 ← TState.fillStackEntry(X0, X1, ⟦LoopCore.PipeCollectionCollector.enumerate ∥ loop=SaverLoop(SaveElements)⟧, ⟨[d0, d0]⟩, mMemo_13@xxxx, null);
 28: X2 ← newStackEntry(⟦sample_bench_2.r8t+2:47_2 _t0 = pipe(xy, _t0) ∥ b=lambda@37:11⸨xc=D5, yc=D7, scale=D9⸩⟧);
 29: X1 ← TState.fillStackEntry(X0, X1, X2, ⟨d0⟩, mMemo_x@xxxx, null);
 30: TState.setStackRest(X0, X1);
 31: return

dist_2([d1, d2, d3], [d4, d5, d6]):
  1: AtomicInteger.incrementAndGet(0);
  2: I13 ← 0;
  3: D14 ← 0;
= 4: I16 ← iAdd(I13, 1);
  5: test I13 == 0; F:→ 16
  6: D17 ← D7;
= 7: test I16 == 1; F:→ 19
  8: D19 ← D1;
= 9: D17 ← dSub(D17, D19);
 10: I13 ← I16;
 11: D14 ← dAdd(D14, dMul(D17, D17));
 12: test I13 < 3; T:→ 4
 13: TState.setResultTemplates(X0, [d0]);
 14: setDouble[](TState.fnResultBytes(X0, 8), 0, D14);
 15: return
-16: test I13 == 1; F:→ 18
 17: D17 ← D9; → 7
-18: D17 ← D11; → 7
-19: test I16 == 2; F:→ 21
 20: D19 ← D3; → 9
-21: D19 ← D5; → 9
---
allocated=6728024/80105, peak=8395
*/
