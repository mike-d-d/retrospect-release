// Model the mechanics of a four-planet solar system, based on
// https://benchmarksgame-team.pages.debian.net/benchmarksgame/description/nbody.html

// state is a (length 5) array of {pos, v, mass}
// ([sun, jupiter, saturn, uranus, neptune]).

if prep {
  _ = simulate(initialState(2), 2)
  return simulate(initialState(4), 3)
}
return simulate(initialState(4), 5e6)

function simulate(state, nSteps) {
  e0 = energy(state)
  // Advance time in steps of 0.01
  for _ in 1 .. nSteps sequential state {
    advance(state=, 0.01)
  }
  e1 = energy(state)
  return [e0, e1]
}

function initialState(nPlanets) {
  solarMass = 4 * pi * pi
  daysPerYear = 365.24

  jupiter = {
    pos: [4.84143144246472090e+00, -1.16032004402742839e+00, -1.03622044471123109e-01],
    v: [1.66007664274403694e-03, 7.69901118419740425e-03, -6.90460016972063023e-05] * daysPerYear | save,
    mass: 9.54791938424326609e-04 * solarMass
  }
  saturn = {
    pos: [8.34336671824457987e+00, 4.12479856412430479e+00, -4.03523417114321381e-01],
    v: [-2.76742510726862411e-03, 4.99852801234917238e-03, 2.30417297573763929e-05] * daysPerYear | save,
    mass: 2.85885980666130812e-04 * solarMass
  }
  uranus = {
    pos: [1.28943695621391310e+01, -1.51111514016986312e+01, -2.23307578892655734e-01],
    v: [2.96460137564761618e-03, 2.37847173959480950e-03, -2.96589568540237556e-05] * daysPerYear | save,
    mass: 4.36624404335156298e-05 * solarMass
  }
  neptune = {
    pos: [1.53796971148509165e+01, -2.59193146099879641e+01, 1.79258772950371181e-01],
    v: [2.68067772490389322e-03, 1.62824170038242295e-03, -9.51592254519715870e-05] * daysPerYear | save,
    mass: 5.15138902046611451e-05 * solarMass
  }

  planets = [jupiter, saturn, uranus, neptune][1..nPlanets]
  planetsMomentum = momentum(^planets) | sum([0, 0, 0])
  sun = { pos: [0, 0, 0], v: -planetsMomentum / solarMass | save, mass: solarMass }
  return [sun] & planets | save
}

function momentum(obj) = obj.v * obj.mass

procedure advance(state=, dt) {
  n = size(state)
  // First update the velocities given the positions...
  for i in 1 .. n-1 sequential state {
    state_i = state[i];
    for j in i+1 .. n sequential state, state_i {
      updateVs(state_i=, state[j]=, dt)
    }
    state[i] = state_i;
  }
  // ... then update the positions given the velocities.
  for i in 1 .. n sequential state {
    // Why save here?  If we don't, deltaPos refers to state, which prevents
    // us from doing the update in place.
    deltaPos = dt * state[i].v | save
    state[i].pos += deltaPos
  }
}

procedure updateVs(b1=, b2=, dt) {
  posDiff = b2.pos - b1.pos
  dSquared = sumSq(posDiff)
  mag = dt / (dSquared * sqrt(dSquared))
  b1.v += posDiff * (b2.mass * mag)
  b2.v -= posDiff * (b1.mass * mag)
}

function sumSq(x) = x**2 | sum

function energy(state) {
  for [i]: body in state {
    // Add in the kinetic energy of each body, and subtract the gravitational
    // potential energy between each pair of bodies
    e << 0.5 * body.mass * sumSq(body.v)
    e << -(potentialEnergy(body, ^state[i+1..]) | sum)
  } collect {
    e =| sum
  }
  return e
}

function potentialEnergy(b1, b2) =
    b1.mass * b2.mass / sqrt(sumSq(b1.pos - b2.pos))

/* CODEGEN simulate RETURNS
  [-0.16907516382852442, -0.16908313397892985]
---
simulate_0(x1:*[]@xxxx, i2):
   1: AtomicInteger.incrementAndGet(0);
   2: X3 ← null;
   3: [d0] ← energy_1(X0, addRef(X1)); X4 ← stackRest; unwind:→ 276
   4: D5 ← double[](TState.fnResultBytes(X0, 0), 0);
   5: TState.clearResultTemplates(X0);
   6: test X4 == null; T:→ 9
   7: addRef(X1); X3 ← newStackEntry(n_body.r8t+6:8_0 e0 = energy(state) {state=X1, nSteps=I2});
   8: X3 ← TState.fillStackEntry(X0, X4, X3, [d0, d0], mMemo_x@xxxx, null);
-  9: test I2 < 0; T:→ 274
  10: I4 ← 1;
= 11: test I2 < I4; T:→ 221
  12: I7 ← Math.addExact(I4, 1); ArithmeticException:→ 272
  13: test X1 is *[]Struct(["mass", "pos", "v"], [d0, [d1, d2, d3], [d4, d5, d6]])@xxxx; F:→ 272
  14: I8 ← Frame1i8x.i0(X1);
  15: I9 ← Math.subtractExact(I8, 1); ArithmeticException:→ 272
  16: test I9 < 0; T:→ 272
  17: I4 ← 1;
= 18: test I9 < I4; T:→ 155
  19: I10 ← Math.addExact(I4, 1); ArithmeticException:→ 33
  20: test X1 is *[]Struct(["mass", "pos", "v"], [d0, [d1, d2, d3], [d4, d5, d6]])@xxxx; F:→ 33
  21: test I4 < 1; T:→ 33
  22: test Frame1i8x.i0(X1) < I4; T:→ 33
  23: I23 ← iSub(I4, 1);
  24: D11 ← double[](Frame1i8x.x0(X1), iShl(I23, 3));
  25: D13 ← double[](Frame1i8x.x1(X1), iShl(I23, 3));
  26: D15 ← double[](Frame1i8x.x2(X1), iShl(I23, 3));
  27: D17 ← double[](Frame1i8x.x3(X1), iShl(I23, 3));
  28: D19 ← double[](Frame1i8x.x4(X1), iShl(I23, 3));
  29: D21 ← double[](Frame1i8x.x5(X1), iShl(I23, 3));
  30: D23 ← double[](Frame1i8x.x6(X1), iShl(I23, 3));
  31: I25 ← Math.addExact(I4, 1); ArithmeticException:→ 33
  32: test lAdd(I8, 1) < I25; F:→ 44
- 33: X10 ← newStackEntry(LoopCore.Iterate.afterIterator {it=RangeIterator(I4, I9, None), loop=loop@53⸨n=I8, dt=0.01⸩, state=loop@53_state⸨state=X1⸩});
  34: X1 ← TState.fillStackEntry(X0, null, X10, loop@53_state⸨state=x0:*[]@xxxx⸩, mMemo_h40@xxxx, null);
= 35: X4 ← newStackEntry(n_body.r8t+6:53_3 _t0 = iterate(_t0, EnumerateValues, loop@53⸨n=n, dt=dt⸩, loop@53_state⸨state=state⸩) {dt=0.01, n=I8});
  36: X1 ← TState.fillStackEntry(X0, X1, X4, x0:*[]@xxxx, mMemo_h81@xxxx, null);
= 37: X1 ← TState.fillStackEntry(X0, X1, n_body.r8t+6:11_1 state = advance(state, 0.01), [loop@10_state⸨state=x0:*[]@xxxx⸩, loop@10, RangeIterator(b0, b0, None)], mMemo_h39@xxxx, null);
  38: X4 ← newStackEntry(LoopCore.Iterate.nextState {loop=loop@10, it=RangeIterator(I7, I2, None)});
  39: X4 ← TState.fillStackEntry(X0, X1, X4, loop@10_state⸨state=x0:*[]@xxxx⸩, mMemo_h40@xxxx, null);
= 40: X1 ← newStackEntry(n_body.r8t+6:10_2 _t0 = iterate(_t0, EnumerateValues, loop@10, loop@10_state⸨state=state⸩) {e0=D5});
  41: X3 ← TState.fillStackEntry(X0, X4, X1, [d0, d0], mMemo_x@xxxx, X3);
= 42: TState.setStackRest(X0, X3);
  43: return
= 44: test I8 < I25; T:→ 143
  45: I26 ← Math.addExact(I25, 1); ArithmeticException:→ 270
  46: test X1 is *[]Struct(["mass", "pos", "v"], [d0, [d1, d2, d3], [d4, d5, d6]])@xxxx; F:→ 270
  47: test I25 < 1; T:→ 270
  48: test Frame1i8x.i0(X1) < I25; T:→ 270
  49: I25 ← iSub(I25, 1);
  50: D27 ← double[](Frame1i8x.x0(X1), iShl(I25, 3));
  51: D29 ← double[](Frame1i8x.x1(X1), iShl(I25, 3));
  52: D31 ← double[](Frame1i8x.x2(X1), iShl(I25, 3));
  53: D33 ← double[](Frame1i8x.x3(X1), iShl(I25, 3));
  54: D35 ← double[](Frame1i8x.x4(X1), iShl(I25, 3));
  55: D37 ← double[](Frame1i8x.x5(X1), iShl(I25, 3));
  56: D39 ← double[](Frame1i8x.x6(X1), iShl(I25, 3));
  57: X1 ← FrameLayout.ensureUnshared(*[]Struct(["mass", "pos", "v"], [d0, [d1, d2, d3], [d4, d5, d6]])@xxxx, X0, X1);
  58: I41 ← 0;
  59: D42 ← 0;
= 60: I44 ← iAdd(I41, 1);
  61: test I41 == 0; F:→ 113
  62: D45 ← D29;
= 63: test I44 == 1; F:→ 116
  64: D47 ← D13;
= 65: D45 ← dSub(D45, D47);
  66: I41 ← I44;
  67: D42 ← dAdd(D42, dMul(D45, D45));
  68: test I41 < 3; T:→ 60
  69: D44 ← Math.sqrt(D42);
  70: test Double.isNaN(D44) == 0; F:→ 249
  71: D44 ← dDiv(0.01, dMul(D42, D44));
  72: test Double.isNaN(D44) == 0; F:→ 249
  73: I41 ← 0;
  74: D42 ← dMul(D27, D44);
= 75: I46 ← iAdd(I41, 1);
  76: test I41 == 0; F:→ 119
  77: D47 ← D29;
= 78: test I46 == 1; F:→ 122
  79: D49 ← D13;
= 80: D47 ← dMul(dSub(D47, D49), D42);
  81: I41 ← iSub(I46, 1);
  82: test I41 == 0; F:→ 125
  83: D49 ← D19;
= 84: D47 ← dAdd(D49, D47);
  85: test I41 == 0; F:→ 128
  86: D19 ← D47;
= 87: I41 ← I46;
  88: test I41 < 3; T:→ 75
  89: I41 ← 0;
  90: D42 ← dMul(D11, D44);
= 91: I44 ← iAdd(I41, 1);
  92: test I41 == 0; F:→ 131
  93: D45 ← D29;
= 94: test I44 == 1; F:→ 134
  95: D47 ← D13;
= 96: D45 ← dMul(dSub(D45, D47), D42);
  97: I41 ← iSub(I44, 1);
  98: test I41 == 0; F:→ 137
  99: D47 ← D35;
=100: D45 ← dSub(D47, D45);
 101: test I41 == 0; F:→ 140
 102: D35 ← D45;
=103: I41 ← I44;
 104: test I41 < 3; T:→ 91
 105: setDouble[](Frame1i8x.x0(X1), iShl(I25, 3), D27);
 106: setDouble[](Frame1i8x.x1(X1), iShl(I25, 3), D29);
 107: setDouble[](Frame1i8x.x2(X1), iShl(I25, 3), D31);
 108: setDouble[](Frame1i8x.x3(X1), iShl(I25, 3), D33);
 109: setDouble[](Frame1i8x.x4(X1), iShl(I25, 3), D35);
 110: setDouble[](Frame1i8x.x5(X1), iShl(I25, 3), D37);
 111: setDouble[](Frame1i8x.x6(X1), iShl(I25, 3), D39);
 112: I25 ← I26; → 44
-113: test I41 == 1; F:→ 115
 114: D45 ← D31; → 63
-115: D45 ← D33; → 63
-116: test I44 == 2; F:→ 118
 117: D47 ← D15; → 65
-118: D47 ← D17; → 65
-119: test I41 == 1; F:→ 121
 120: D47 ← D31; → 78
-121: D47 ← D33; → 78
-122: test I46 == 2; F:→ 124
 123: D49 ← D15; → 80
-124: D49 ← D17; → 80
-125: test I41 == 1; F:→ 127
 126: D49 ← D21; → 84
-127: D49 ← D23; → 84
-128: test I41 == 1; F:→ 130
 129: D21 ← D47; → 87
-130: D23 ← D47; → 87
-131: test I41 == 1; F:→ 133
 132: D45 ← D31; → 94
-133: D45 ← D33; → 94
-134: test I44 == 2; F:→ 136
 135: D47 ← D15; → 96
-136: D47 ← D17; → 96
-137: test I41 == 1; F:→ 139
 138: D47 ← D37; → 100
-139: D47 ← D39; → 100
-140: test I41 == 1; F:→ 142
 141: D37 ← D45; → 103
-142: D39 ← D45; → 103
-143: test X1 is *[]Struct(["mass", "pos", "v"], [d0, [d1, d2, d3], [d4, d5, d6]])@xxxx; F:→ 270
 144: test Frame1i8x.i0(X1) < I4; T:→ 270
 145: I4 ← iSub(I4, 1);
 146: X1 ← FrameLayout.ensureUnshared(*[]Struct(["mass", "pos", "v"], [d0, [d1, d2, d3], [d4, d5, d6]])@xxxx, X0, X1);
 147: setDouble[](Frame1i8x.x0(X1), iShl(I4, 3), D11);
 148: setDouble[](Frame1i8x.x1(X1), iShl(I4, 3), D13);
 149: setDouble[](Frame1i8x.x2(X1), iShl(I4, 3), D15);
 150: setDouble[](Frame1i8x.x3(X1), iShl(I4, 3), D17);
 151: setDouble[](Frame1i8x.x4(X1), iShl(I4, 3), D19);
 152: setDouble[](Frame1i8x.x5(X1), iShl(I4, 3), D21);
 153: setDouble[](Frame1i8x.x6(X1), iShl(I4, 3), D23);
 154: I4 ← I10; → 18
-155: I4 ← 1;
=156: test I8 < I4; T:→ 220
 157: I9 ← Math.addExact(I4, 1); ArithmeticException:→ 247
 158: test X1 is *[]Struct(["mass", "pos", "v"], [d0, [d1, d2, d3], [d4, d5, d6]])@xxxx; F:→ 247
 159: test I4 < 1; T:→ 247
 160: test Frame1i8x.i0(X1) < I4; T:→ 247
 161: I10 ← iSub(I4, 1);
 162: D11 ← double[](Frame1i8x.x4(X1), iShl(I10, 3));
 163: D13 ← double[](Frame1i8x.x5(X1), iShl(I10, 3));
 164: D15 ← double[](Frame1i8x.x6(X1), iShl(I10, 3));
 165: I10 ← 0;
 166: D17 ← 0;
 167: D19 ← 0;
=168: I21 ← iAdd(I10, 1);
 169: test I10 == 0; F:→ 176
 170: D22 ← D11;
=171: D22 ← dMul(0.01, D22);
 172: test I21 == 1; T:→ 179
 173: test I21 == 2; F:→ 181
 174: I10 ← 2;
 175: D19 ← D22; → 168
-176: test I10 == 1; F:→ 178
 177: D22 ← D13; → 171
-178: D22 ← D15; → 171
-179: I10 ← 1;
 180: D17 ← D22; → 168
-181: test Frame1i8x.i0(X1) < I4; T:→ 235
 182: I4 ← iSub(I4, 1);
 183: D10 ← double[](Frame1i8x.x0(X1), iShl(I4, 3));
 184: D12 ← double[](Frame1i8x.x1(X1), iShl(I4, 3));
 185: D14 ← double[](Frame1i8x.x2(X1), iShl(I4, 3));
 186: D24 ← double[](Frame1i8x.x3(X1), iShl(I4, 3));
 187: D26 ← double[](Frame1i8x.x4(X1), iShl(I4, 3));
 188: D28 ← double[](Frame1i8x.x5(X1), iShl(I4, 3));
 189: D30 ← double[](Frame1i8x.x6(X1), iShl(I4, 3));
 190: X1 ← FrameLayout.ensureUnshared(*[]Struct(["mass", "pos", "v"], [d0, [d1, d2, d3], [d4, d5, d6]])@xxxx, X0, X1);
 191: I16 ← 0;
=192: I21 ← iAdd(I16, 1);
 193: test I16 == 0; F:→ 211
 194: D32 ← D17;
=195: I16 ← iSub(I21, 1);
 196: test I16 == 0; F:→ 214
 197: D34 ← D12;
=198: D32 ← dAdd(D34, D32);
 199: test I16 == 0; F:→ 217
 200: D12 ← D32;
=201: I16 ← I21;
 202: test I16 < 3; T:→ 192
 203: setDouble[](Frame1i8x.x0(X1), iShl(I4, 3), D10);
 204: setDouble[](Frame1i8x.x1(X1), iShl(I4, 3), D12);
 205: setDouble[](Frame1i8x.x2(X1), iShl(I4, 3), D14);
 206: setDouble[](Frame1i8x.x3(X1), iShl(I4, 3), D24);
 207: setDouble[](Frame1i8x.x4(X1), iShl(I4, 3), D26);
 208: setDouble[](Frame1i8x.x5(X1), iShl(I4, 3), D28);
 209: setDouble[](Frame1i8x.x6(X1), iShl(I4, 3), D30);
 210: I4 ← I9; → 156
-211: test I16 == 1; F:→ 213
 212: D32 ← D19; → 195
-213: D32 ← D22; → 195
-214: test I16 == 1; F:→ 216
 215: D34 ← D14; → 198
-216: D34 ← D24; → 198
-217: test I16 == 1; F:→ 219
 218: D14 ← D32; → 201
-219: D24 ← D32; → 201
-220: I4 ← I7; → 11
-221: [d0] ← energy_1(X0, X1); X4 ← stackRest; unwind:→ 233
 222: D7 ← double[](TState.fnResultBytes(X0, 0), 0);
 223: TState.clearResultTemplates(X0);
 224: test X4 == null; T:→ 227
 225: X1 ← newStackEntry(n_body.r8t+6:13_4 e1 = energy(state) {e0=D5});
 226: X3 ← TState.fillStackEntry(X0, X4, X1, [d0, d0], mMemo_x@xxxx, X3);
-227: TState.setResultTemplates(X0, [[d0, d8]]);
 228: X1 ← TState.fnResultBytes(X0, 16);
 229: setDouble[](X1, 0, D5);
 230: setDouble[](X1, 8, D7);
 231: TState.setStackRest(X0, X3);
 232: return
-233: X1 ← newStackEntry(n_body.r8t+6:13_4 e1 = energy(state) {e0=D5});
 234: X3 ← TState.fillStackEntry(X0, X4, X1, [d0, d0], mMemo_x@xxxx, X3); → 42
-235: X10 ← newStackEntry(ArrayCore.NextArrayIterator.startLoop {index=3, it=ArrayIterator([D11, D13, D15], EnumerateAllKeys, 3)});
 236: X41 ← TState.fillStackEntry(X0, null, X10, [⸨[[b0], d0]; Absent⸩, ArrayIterator([d0, d0, d0], EnumerateAllKeys, b0), TransformedIterator((empty), EnumerateAllKeys, `multiply:2:.#`(0.01))], mMemo_1@xxxx, null);
 237: X41 ← TState.fillStackEntry(X0, X41, CollectionCore.NextTransformedIterator.next {it=TransformedIterator(ToBeSet, EnumerateAllKeys, `multiply:2:.#`(0.01))}, [⸨[[b0], d0]; Absent⸩, TransformedIterator(ArrayIterator([d0, d0, d0], EnumerateAllKeys, b0), EnumerateAllKeys, `multiply:2:.#`(0.01)), SaverLoop(SaveElements), [d0, d0, d0]], mMemo_4@xxxx, null);
 238: X10 ← newStackEntry(LoopCore.Iterate.next {loop=SaverLoop(SaveElements), state=[D17, D19, D22]});
 239: X11 ← TState.fillStackEntry(X0, X41, X10, [[d0, d0, d0], SaverLoop(SaveElements)], mMemo_10@xxxx, null);
 240: X11 ← TState.fillStackEntry(X0, X11, LoopCore.enumerateDefault, [[d0, d0, d0], SaverLoop(SaveElements)], mMemo_11@xxxx, null);
 241: X11 ← TState.fillStackEntry(X0, X11, LoopCore.PipeCollectionCollector.enumerate {loop=SaverLoop(SaveElements)}, [d0, d0, d0], mMemo_18@xxxx, null);
 242: X10 ← newStackEntry(n_body.r8t+6:64_7 deltaPos = pipe(_t0, _t1) {state=X1, i=I4});
 243: X1 ← TState.fillStackEntry(X0, X11, X10, [loop@61_state⸨state=x0:*[]@xxxx⸩, loop@61⸨dt=0.01⸩, RangeIterator(b0, b0, None)], mMemo_h42@xxxx, null);
 244: X4 ← newStackEntry(LoopCore.Iterate.nextState {loop=loop@61⸨dt=0.01⸩, it=RangeIterator(I9, I8, None)});
 245: X1 ← TState.fillStackEntry(X0, X1, X4, loop@61_state⸨state=x0:*[]@xxxx⸩, mMemo_h40@xxxx, null);
=246: X1 ← TState.fillStackEntry(X0, X1, n_body.r8t+6:61_6 _t0 = iterate(_t0, EnumerateValues, loop@61⸨dt=dt⸩, loop@61_state⸨state=state⸩), x0:*[]@xxxx, mMemo_h81@xxxx, null); → 37
-247: X9 ← newStackEntry(LoopCore.Iterate.afterIterator {it=RangeIterator(I4, I8, None), loop=loop@61⸨dt=0.01⸩, state=loop@61_state⸨state=X1⸩});
 248: X1 ← TState.fillStackEntry(X0, null, X9, loop@61_state⸨state=x0:*[]@xxxx⸩, mMemo_h40@xxxx, null); → 246
-249: X41 ← newStackEntry(ArrayCore.NextArrayIterator.startLoop {index=3, it=ArrayIterator([D29, D31, D33], EnumerateAllKeys, 3)});
 250: X41 ← TState.fillStackEntry(X0, null, X41, [⸨[[b0], d0]; Absent⸩, ArrayIterator([d0, d0, d0], EnumerateAllKeys, b0), JoinedIterator((empty), [d0, d0, d0], EnumerateValues)], mMemo_1@xxxx, null);
 251: X44 ← newStackEntry(CollectionCore.NextJoinedIterator.next {it=JoinedIterator((empty), [D13, D15, D17], EnumerateValues)});
 252: X41 ← TState.fillStackEntry(X0, X41, X44, [⸨[d0, d0]; Absent⸩, JoinedIterator(ArrayIterator([d0, d0, d0], EnumerateAllKeys, b0), [d0, d0, d0], EnumerateValues), TransformedIterator((empty), EnumerateValues, `subtract:2`)], mMemo_4@xxxx, null);
 253: X41 ← TState.fillStackEntry(X0, X41, CollectionCore.NextTransformedIterator.next {it=TransformedIterator(ToBeSet, EnumerateValues, `subtract:2`)}, [⸨d0; Absent⸩, TransformedIterator(JoinedIterator(ArrayIterator([d0, d0, d0], EnumerateAllKeys, b0), [d0, d0, d0], EnumerateValues), EnumerateValues, `subtract:2`), TransformedIterator((empty), EnumerateValues, `exponent:2:#.`(2))], mMemo_7@xxxx, null);
 254: X41 ← TState.fillStackEntry(X0, X41, CollectionCore.NextTransformedIterator.next {it=TransformedIterator(ToBeSet, EnumerateValues, `exponent:2:#.`(2))}, [⸨d0; Absent⸩, TransformedIterator(TransformedIterator(JoinedIterator(ArrayIterator([d0, d0, d0], EnumerateAllKeys, b0), [d0, d0, d0], EnumerateValues), EnumerateValues, `subtract:2`), EnumerateValues, `exponent:2:#.`(2)), Sum(0), d0], mMemo_10@xxxx, null);
 255: X44 ← newStackEntry(LoopCore.Iterate.next {loop=Sum(0), state=D42});
 256: X41 ← TState.fillStackEntry(X0, X41, X44, [d0, Sum(0)], mMemo_19@xxxx, null);
 257: X41 ← TState.fillStackEntry(X0, X41, LoopCore.enumerateDefault, [d0, Sum(0)], mMemo_20@xxxx, null);
 258: X41 ← TState.fillStackEntry(X0, X41, LoopCore.PipeCollectionCollector.enumerate {loop=Sum(0)}, d0, mMemo_24@xxxx, null);
 259: X41 ← TState.fillStackEntry(X0, X41, n_body.r8t+6:77_2 _t0 = pipe(_t0, _t1), d0, mMemo_27@xxxx, null);
 260: X42 ← newStackEntry(n_body.r8t+6:71_3 dSquared = sumSq(posDiff) {b1=Struct(["mass", "pos", "v"], [D11, [D13, D15, D17], [D19, D21, D23]]), b2=Struct(["mass", "pos", "v"], [D27, [D29, D31, D33], [D35, D37, D39]]), dt=0.01, posDiff=TransformedMatrix(JoinedMatrix([D29, D31, D33], [D13, D15, D17]), `subtract:2`)});
 261: X11 ← TState.fillStackEntry(X0, X41, X42, [Struct(["mass", "pos", "v"], [d0, [d0, d0, d0], [d0, d0, d0]]), Struct(["mass", "pos", "v"], [d0, [d0, d0, d0], [d0, d0, d0]])], mMemo_h104@xxxx, null);
 262: X12 ← newStackEntry(n_body.r8t+6:56_4 state_i, _t0 = updateVs(state_i, _t0, dt) {_t1=ArrayUpdater(X1, I25)});
 263: X11 ← TState.fillStackEntry(X0, X11, X12, [loop@55_state⸨state=x0:*[]@xxxx, state_i=Struct(["mass", "pos", "v"], [d0, [d0, d0, d0], [d0, d0, d0]])⸩, loop@55⸨dt=0.01⸩, RangeIterator(b0, b0, None)], mMemo_h42@xxxx, null);
 264: X1 ← newStackEntry(LoopCore.Iterate.nextState {loop=loop@55⸨dt=0.01⸩, it=RangeIterator(I26, I8, None)});
 265: X11 ← TState.fillStackEntry(X0, X11, X1, loop@55_state⸨state=x0:*[]@xxxx, state_i=Struct(["mass", "pos", "v"], [d0, [d0, d0, d0], [d0, d0, d0]])⸩, mMemo_h40@xxxx, null);
=266: X1 ← newStackEntry(n_body.r8t+6:55_6 _t0 = iterate(_t0, EnumerateValues, loop@55⸨dt=dt⸩, loop@55_state⸨state=state, state_i=state_i⸩) {i=I4});
 267: X1 ← TState.fillStackEntry(X0, X11, X1, [loop@53_state⸨state=x0:*[]@xxxx⸩, loop@53⸨n=b0, dt=0.01⸩, RangeIterator(b0, b0, None)], mMemo_h46@xxxx, null);
 268: X4 ← newStackEntry(LoopCore.Iterate.nextState {loop=loop@53⸨n=I8, dt=0.01⸩, it=RangeIterator(I10, I9, None)});
 269: X1 ← TState.fillStackEntry(X0, X1, X4, loop@53_state⸨state=x0:*[]@xxxx⸩, mMemo_h40@xxxx, null); → 35
-270: X26 ← newStackEntry(LoopCore.Iterate.afterIterator {it=RangeIterator(I25, I8, None), loop=loop@55⸨dt=0.01⸩, state=loop@55_state⸨state=X1, state_i=Struct(["mass", "pos", "v"], [D11, [D13, D15, D17], [D19, D21, D23]])⸩});
 271: X11 ← TState.fillStackEntry(X0, null, X26, loop@55_state⸨state=x0:*[]@xxxx, state_i=Struct(["mass", "pos", "v"], [d0, [d0, d0, d0], [d0, d0, d0]])⸩, mMemo_h40@xxxx, null); → 266
-272: X7 ← newStackEntry(LoopCore.Iterate.afterIterator {it=RangeIterator(I4, I2, None), loop=loop@10, state=loop@10_state⸨state=X1⸩});
 273: X4 ← TState.fillStackEntry(X0, null, X7, loop@10_state⸨state=x0:*[]@xxxx⸩, mMemo_h40@xxxx, null); → 40
-274: X4 ← newStackEntry(n_body.r8t+6:10_1 _t0 = range(1, nSteps) {state=X1, nSteps=I2, e0=D5});
 275: X3 ← TState.fillStackEntry(X0, null, X4, [d0, d0], mMemo_x@xxxx, X3); → 42
-276: X3 ← newStackEntry(n_body.r8t+6:8_0 e0 = energy(state) {state=X1, nSteps=I2});
 277: X3 ← TState.fillStackEntry(X0, X4, X3, [d0, d0], mMemo_x@xxxx, null); → 42

energy_1(x1:*[]@xxxx):
   1: AtomicInteger.incrementAndGet(0);
   2: I2 ← 0;
   3: D3 ← 0;
=  4: test X1 is *[]Struct(["mass", "pos", "v"], [d0, [d1, d2, d3], [d4, d5, d6]])@xxxx; F:→ 121
   5: test I2 < Frame1i8x.i0(X1); F:→ 91
   6: I5 ← iAdd(I2, 1);
   7: D6 ← double[](Frame1i8x.x0(X1), iShl(I2, 3));
   8: D8 ← double[](Frame1i8x.x1(X1), iShl(I2, 3));
   9: D10 ← double[](Frame1i8x.x2(X1), iShl(I2, 3));
  10: D12 ← double[](Frame1i8x.x3(X1), iShl(I2, 3));
  11: D14 ← double[](Frame1i8x.x4(X1), iShl(I2, 3));
  12: D16 ← double[](Frame1i8x.x5(X1), iShl(I2, 3));
  13: D18 ← double[](Frame1i8x.x6(X1), iShl(I2, 3));
  14: D20 ← dMul(0.5, D6);
  15: I2 ← 0;
  16: D22 ← 0;
= 17: I24 ← iAdd(I2, 1);
  18: test I2 == 0; F:→ 47
  19: D25 ← D14;
= 20: I2 ← I24;
  21: D22 ← dAdd(D22, dMul(D25, D25));
  22: test I2 < 3; T:→ 17
  23: D24 ← dAdd(D3, dMul(D20, D22));
  24: I26 ← Math.addExact(I5, 1); ArithmeticException:→ 31
  25: test 0 < I26; F:→ 31
  26: I2 ← Frame1i8x.i0(X1);
  27: I27 ← iAdd(iSub(I2, I26), 1);
  28: test I27 < 0; T:→ 31
  29: test I27 < I2; T:→ 50
  30: test Frame1i8x.i0(X1) == 0; T:→ 84
- 31: X2 ← newStackEntry(ArrayCore.NextArrayIterator.startLoop {index=3, it=ArrayIterator([D14, D16, D18], EnumerateValues, 3)});
  32: X2 ← TState.fillStackEntry(X0, null, X2, [⸨d0; Absent⸩, ArrayIterator([d0, d0, d0], EnumerateValues, b0), TransformedIterator((empty), EnumerateValues, `exponent:2:#.`(2))], mMemo_1@xxxx, null);
  33: X2 ← TState.fillStackEntry(X0, X2, CollectionCore.NextTransformedIterator.next {it=TransformedIterator(ToBeSet, EnumerateValues, `exponent:2:#.`(2))}, [⸨d0; Absent⸩, TransformedIterator(ArrayIterator([d0, d0, d0], EnumerateValues, b0), EnumerateValues, `exponent:2:#.`(2)), Sum(0), d0], mMemo_4@xxxx, null);
  34: X24 ← newStackEntry(LoopCore.Iterate.next {loop=Sum(0), state=D22});
  35: X2 ← TState.fillStackEntry(X0, X2, X24, [d0, Sum(0)], mMemo_11@xxxx, null);
  36: X2 ← TState.fillStackEntry(X0, X2, LoopCore.enumerateDefault, [d0, Sum(0)], mMemo_12@xxxx, null);
  37: X2 ← TState.fillStackEntry(X0, X2, LoopCore.PipeCollectionCollector.enumerate {loop=Sum(0)}, d0, mMemo_16@xxxx, null);
  38: X2 ← TState.fillStackEntry(X0, X2, n_body.r8t+6:77_2 _t0 = pipe(_t0, _t1), d0, mMemo_19@xxxx, null);
  39: addRef(X1); X22 ← newStackEntry(n_body.r8t+6:83_9 _t1 = sumSq(_t1) {e_ro=LoopRO(EnumerateValues, Sum(0), True), e_rw=LoopRW(Absent, D3), i=I5, body=Struct(["mass", "pos", "v"], [D6, [D8, D10, D12], [D14, D16, D18]]), state=X1, _key=[I5], _t0=D20});
  40: X2 ← TState.fillStackEntry(X0, X2, X22, [loop@80_state⸨e_rw=LoopRW(Absent, d0)⸩, loop@80⸨e_ro=LoopRO(EnumerateValues, Sum(0), True), state=x0:*[]@xxxx⸩, ArrayIterator(x0:*[]@xxxx, EnumerateWithKeys, b0)], mMemo_h84@xxxx, null);
= 41: X3 ← newStackEntry(LoopCore.Iterate.nextState {loop=loop@80⸨e_ro=LoopRO(EnumerateValues, Sum(0), True), state=X1⸩, it=ArrayIterator(X1, EnumerateWithKeys, I5)});
  42: X1 ← TState.fillStackEntry(X0, X2, X3, loop@80_state⸨e_rw=LoopRW(Absent, d0)⸩, mMemo_h40@xxxx, null);
= 43: X1 ← TState.fillStackEntry(X0, X1, LoopCore.enumerateDefault, loop@80_state⸨e_rw=LoopRW(Absent, d0)⸩, mMemo_h38@xxxx, null);
  44: X1 ← TState.fillStackEntry(X0, X1, n_body.r8t+6:80_2 _t0 = enumerate(state, _t1, loop@80⸨e_ro=e_ro, state=state⸩, loop@80_state⸨e_rw=_t0⸩) {e_ro=LoopRO(EnumerateValues, Sum(0), True)}, d0, mMemo_x@xxxx, null);
  45: TState.setStackRest(X0, X1);
  46: return
- 47: test I2 == 1; F:→ 49
  48: D25 ← D16; → 20
- 49: D25 ← D18; → 20
- 50: test I27 == 0; T:→ 84
  51: D3 ← 0;
  52: I2 ← 0;
= 53: I20 ← iAdd(I2, 1);
  54: test I20 < 1; T:→ 117
  55: test I27 < I20; T:→ 117
  56: I21 ← iSub(iAdd(I26, I20), 1);
  57: test I21 < 1; T:→ 117
  58: test Frame1i8x.i0(X1) < I21; T:→ 117
  59: I2 ← iSub(I21, 1);
  60: D21 ← double[](Frame1i8x.x1(X1), iShl(I2, 3));
  61: D28 ← double[](Frame1i8x.x2(X1), iShl(I2, 3));
  62: D30 ← double[](Frame1i8x.x3(X1), iShl(I2, 3));
  63: D32 ← dMul(D6, double[](Frame1i8x.x0(X1), iShl(I2, 3)));
  64: I2 ← 0;
  65: D34 ← 0;
= 66: I23 ← iAdd(I2, 1);
  67: test I2 == 0; F:→ 85
  68: D36 ← D8;
= 69: test I23 == 1; F:→ 88
  70: D38 ← D21;
= 71: D36 ← dSub(D36, D38);
  72: I2 ← I23;
  73: D34 ← dAdd(D34, dMul(D36, D36));
  74: test I2 < 3; T:→ 66
  75: D36 ← Math.sqrt(D34);
  76: test Double.isNaN(D36) == 0; F:→ 95
  77: D36 ← dDiv(D32, D36);
  78: test Double.isNaN(D36) == 0; F:→ 95
  79: I2 ← I20;
  80: D3 ← dAdd(D3, D36);
  81: test I2 < I27; T:→ 53
= 82: I2 ← I5;
  83: D3 ← dAdd(D24, dNeg(D3)); → 4
- 84: D3 ← 0; → 82
- 85: test I2 == 1; F:→ 87
  86: D36 ← D10; → 69
- 87: D36 ← D12; → 69
- 88: test I23 == 2; F:→ 90
  89: D38 ← D28; → 71
- 90: D38 ← D30; → 71
- 91: dropRef{X1};
  92: TState.setResultTemplates(X0, [d0]);
  93: setDouble[](TState.fnResultBytes(X0, 8), 0, D3);
  94: return
- 95: X2 ← newStackEntry(ArrayCore.NextArrayIterator.startLoop {index=3, it=ArrayIterator([D8, D10, D12], EnumerateAllKeys, 3)});
  96: X2 ← TState.fillStackEntry(X0, null, X2, [⸨[[b0], d0]; Absent⸩, ArrayIterator([d0, d0, d0], EnumerateAllKeys, b0), JoinedIterator((empty), [d0, d0, d0], EnumerateValues)], mMemo_1@xxxx, null);
  97: X23 ← newStackEntry(CollectionCore.NextJoinedIterator.next {it=JoinedIterator((empty), [D21, D28, D30], EnumerateValues)});
  98: X2 ← TState.fillStackEntry(X0, X2, X23, [⸨[d0, d0]; Absent⸩, JoinedIterator(ArrayIterator([d0, d0, d0], EnumerateAllKeys, b0), [d0, d0, d0], EnumerateValues), TransformedIterator((empty), EnumerateValues, `subtract:2`)], mMemo_4@xxxx, null);
  99: X2 ← TState.fillStackEntry(X0, X2, CollectionCore.NextTransformedIterator.next {it=TransformedIterator(ToBeSet, EnumerateValues, `subtract:2`)}, [⸨d0; Absent⸩, TransformedIterator(JoinedIterator(ArrayIterator([d0, d0, d0], EnumerateAllKeys, b0), [d0, d0, d0], EnumerateValues), EnumerateValues, `subtract:2`), TransformedIterator((empty), EnumerateValues, `exponent:2:#.`(2))], mMemo_7@xxxx, null);
 100: X2 ← TState.fillStackEntry(X0, X2, CollectionCore.NextTransformedIterator.next {it=TransformedIterator(ToBeSet, EnumerateValues, `exponent:2:#.`(2))}, [⸨d0; Absent⸩, TransformedIterator(TransformedIterator(JoinedIterator(ArrayIterator([d0, d0, d0], EnumerateAllKeys, b0), [d0, d0, d0], EnumerateValues), EnumerateValues, `subtract:2`), EnumerateValues, `exponent:2:#.`(2)), Sum(0), d0], mMemo_10@xxxx, null);
 101: X21 ← newStackEntry(LoopCore.Iterate.next {loop=Sum(0), state=D34});
 102: X2 ← TState.fillStackEntry(X0, X2, X21, [d0, Sum(0)], mMemo_19@xxxx, null);
 103: X2 ← TState.fillStackEntry(X0, X2, LoopCore.enumerateDefault, [d0, Sum(0)], mMemo_20@xxxx, null);
 104: X2 ← TState.fillStackEntry(X0, X2, LoopCore.PipeCollectionCollector.enumerate {loop=Sum(0)}, d0, mMemo_24@xxxx, null);
 105: X2 ← TState.fillStackEntry(X0, X2, n_body.r8t+6:77_2 _t0 = pipe(_t0, _t1), d0, mMemo_27@xxxx, null);
 106: X21 ← newStackEntry(n_body.r8t+6:92_6 _t1 = sumSq(_t1) {_t0=D32});
 107: X2 ← TState.fillStackEntry(X0, X2, X21, d0, mMemo_h42@xxxx, null);
 108: X2 ← TState.fillStackEntry(X0, X2, n_body.r8t+6:84_1 _a0 = potentialEnergy(body, _a1), [d0, Undef, TransformedIterator(BaseIterator(EnumerateValues, [b0], [b0]), EnumerateValues, `element:2:.#`(SubMatrix(x0:*[]@xxxx, [b0], [0], [b0]))), TransformedIterator((empty), EnumerateValues, iLambda@84:11⸨body=Struct(["mass", "pos", "v"], [d0, [d0, d0, d0], [d0, d0, d0]])⸩)], mMemo_h39@xxxx, null);
 109: addRef(X1); X21 ← newStackEntry(CollectionCore.NextTransformedIterator.at {key=Undef, innerIt=TransformedIterator(BaseIterator(EnumerateValues, [I20], [I27]), EnumerateValues, `element:2:.#`(SubMatrix(X1, [I26], [0], [I27]))), it=TransformedIterator((empty), EnumerateValues, iLambda@84:11⸨body=Struct(["mass", "pos", "v"], [D6, [D8, D10, D12], [D14, D16, D18]])⸩)});
 110: X2 ← TState.fillStackEntry(X0, X2, X21, [⸨d0; Absent⸩, TransformedIterator(⸨ArrayIterator([], EnumerateValues, 0); TransformedIterator(BaseIterator(EnumerateValues, [b0], [b0]), EnumerateValues, `element:2:.#`(SubMatrix(x0:*[]@xxxx, [b0], [0], [b0])))⸩, EnumerateValues, iLambda@84:11⸨body=Struct(["mass", "pos", "v"], [d0, [d0, d0, d0], [d0, d0, d0]])⸩), Sum(0), d0], mMemo_h44@xxxx, null);
=111: X6 ← newStackEntry(LoopCore.Iterate.next {loop=Sum(0), state=D3});
 112: X2 ← TState.fillStackEntry(X0, X2, X6, [d0, Sum(0)], mMemo_h45@xxxx, null);
 113: X2 ← TState.fillStackEntry(X0, X2, LoopCore.enumerateDefault, [d0, Sum(0)], mMemo_h38@xxxx, null);
 114: X2 ← TState.fillStackEntry(X0, X2, LoopCore.PipeCollectionCollector.enumerate {loop=Sum(0)}, d0, mMemo_h41@xxxx, null);
 115: X3 ← newStackEntry(n_body.r8t+6:84_17 _t0 = pipe(_t0, _t1) {e_ro=LoopRO(EnumerateValues, Sum(0), True), e_rw=LoopRW(Absent, D24), _key=[I5]});
 116: X2 ← TState.fillStackEntry(X0, X2, X3, [loop@80_state⸨e_rw=LoopRW(Absent, d0)⸩, loop@80⸨e_ro=LoopRO(EnumerateValues, Sum(0), True), state=x0:*[]@xxxx⸩, ArrayIterator(x0:*[]@xxxx, EnumerateWithKeys, b0)], mMemo_h84@xxxx, null); → 41
-117: addRef(X1); X20 ← newStackEntry(CollectionCore.NextTransformedIterator.loop {innerIt=BaseIterator(EnumerateValues, [I2], [I27]), it=TransformedIterator((empty), EnumerateValues, `element:2:.#`(SubMatrix(X1, [I26], [0], [I27])))});
 118: X2 ← TState.fillStackEntry(X0, null, X20, [⸨Absent; Struct(["mass", "pos", "v"], [d0, [d0, d0, d0], [d0, d0, d0]])⸩, ⸨ArrayIterator([], EnumerateValues, 0); TransformedIterator(BaseIterator(EnumerateValues, [b0], [b0]), EnumerateValues, `element:2:.#`(SubMatrix(x0:*[]@xxxx, [b0], [0], [b0])))⸩, TransformedIterator((empty), EnumerateValues, iLambda@84:11⸨body=Struct(["mass", "pos", "v"], [d0, [d0, d0, d0], [d0, d0, d0]])⸩)], mMemo_5@xxxx, null);
 119: X20 ← newStackEntry(CollectionCore.NextTransformedIterator.next {it=TransformedIterator((empty), EnumerateValues, iLambda@84:11⸨body=Struct(["mass", "pos", "v"], [D6, [D8, D10, D12], [D14, D16, D18]])⸩)});
 120: X2 ← TState.fillStackEntry(X0, X2, X20, [⸨d0; Absent⸩, TransformedIterator(⸨ArrayIterator([], EnumerateValues, 0); TransformedIterator(BaseIterator(EnumerateValues, [b0], [b0]), EnumerateValues, `element:2:.#`(SubMatrix(x0:*[]@xxxx, [b0], [0], [b0])))⸩, EnumerateValues, iLambda@84:11⸨body=Struct(["mass", "pos", "v"], [d0, [d0, d0, d0], [d0, d0, d0]])⸩), Sum(0), d0], mMemo_h44@xxxx, null); → 111
-121: addRef(X1); X5 ← newStackEntry(ArrayCore.NextArrayIterator.startLoop {index=I2, it=ArrayIterator(X1, EnumerateWithKeys, I2)});
 122: X2 ← TState.fillStackEntry(X0, null, X5, [⸨[[b0], Struct(["mass", "pos", "v"], [d0, [d0, d0, d0], [d0, d0, d0]])]; Absent⸩, ArrayIterator(x0:*[]@xxxx, EnumerateWithKeys, b0), loop@80⸨e_ro=LoopRO(EnumerateValues, Sum(0), True), state=x0:*[]@xxxx⸩, loop@80_state⸨e_rw=LoopRW(Absent, d0)⸩], mMemo_1@xxxx, null);
 123: X5 ← newStackEntry(LoopCore.Iterate.next {loop=loop@80⸨e_ro=LoopRO(EnumerateValues, Sum(0), True), state=X1⸩, state=loop@80_state⸨e_rw=LoopRW(Absent, D3)⸩});
 124: X1 ← TState.fillStackEntry(X0, X2, X5, loop@80_state⸨e_rw=LoopRW(Absent, d0)⸩, mMemo_h40@xxxx, null); → 43
---
allocated=40112/1504, peak=96
*/
